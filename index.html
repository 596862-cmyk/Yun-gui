<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNI雲貴分會 - 新手村任務系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            overflow-x: hidden;
        }
        .task-card { transition: all 0.3s ease; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .completed { background: linear-gradient(135deg, #10b981, #059669); }
        .in-progress { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .not-started { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-circle { transition: stroke-dashoffset 0.35s; }
        .category-filter { transition: all 0.3s ease; }
        .category-filter.active { background: linear-gradient(135deg, #8b5cf6, #7c3aed); transform: scale(1.05); }
        * { box-sizing: border-box; }
        .modal-overlay { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 min-h-screen">
    <div id="loginScreen" class="min-h-screen px-4 py-8">
        <div class="container mx-auto max-w-6xl">
            <div class="flex justify-center mb-8">
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full border border-white/20">
                    <div class="text-center mb-8">
                        <h1 class="text-4xl font-bold text-white mb-2">🏢 BNI雲貴分會</h1>
                        <h2 class="text-2xl font-semibold text-blue-200 mb-4">新手村任務系統</h2>
                        <p class="text-lg text-blue-300">請輸入您的導生資訊</p>
                        <p class="text-sm text-yellow-300 mt-2">⚠️ 導生帳號由導師建立，無法自行註冊</p>
                    </div>
                    <div id="loginFormContainer">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-white text-base font-medium mb-2">導生姓名</label>
                                <input type="text" id="memberName" required class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 text-base" placeholder="請輸入您的姓名">
                            </div>
                            <div>
                                <label class="block text-white text-base font-medium mb-2">導生密碼</label>
                                <input type="password" id="memberPassword" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 text-base" placeholder="請輸入導師為您設定的密碼">
                            </div>
                            <button type="button" id="loginButton" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all text-lg">
                                開始我的新手村之旅
                            </button>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <button type="button" id="showAdminBtn" class="text-blue-300 hover:text-blue-200 text-sm underline">
                            導師登入
                        </button>
                    </div>
                </div>
            </div>
            <div id="graduatedMembersSection" class="mb-8 hidden">
                <div class="bg-gradient-to-r from-yellow-500/20 to-orange-500/20 backdrop-blur-lg rounded-2xl p-6 border border-yellow-400/30">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-yellow-300 mb-2">🏆 已出村導生表揚 🏆</h2>
                        <p class="text-yellow-200">恭喜以下導生完成所有必修任務，成為BNI專業導生！</p>
                    </div>
                    <div id="graduatedMembersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>
            <div id="loginRankingSection" class="hidden">
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-white mb-2">📊 導生排行榜</h2>
                        <p class="text-blue-300">新手村任務完成進度排名</p>
                    </div>
                    <div id="loginRankingList" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="mainContent" class="container mx-auto px-4 py-8 hidden">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-4 mb-6 border border-white/20">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-lg" id="memberAvatar"></div>
                    <div>
                        <h3 class="text-lg font-semibold text-white" id="displayMemberName">導生姓名</h3>
                        <p class="text-blue-200 text-sm">BNI雲貴分會導生</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button type="button" id="logoutBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm transition-all">登出</button>
                </div>
            </div>
        </div>
        <div class="text-center mb-8">
            <h1 class="text-5xl md:text-6xl font-bold text-white mb-2">🏢 BNI雲貴分會</h1>
            <h2 class="text-3xl md:text-4xl font-semibold text-blue-200 mb-4">新手村任務系統</h2>
            <p class="text-xl text-blue-300">完成所有關卡，成為BNI專業導生！</p>
        </div>
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-8 border border-white/20">
            <div class="flex flex-col md:flex-row items-center justify-between mb-6">
                <h2 class="text-2xl md:text-3xl font-semibold text-white mb-4 md:mb-0">總體進度</h2>
                <div class="flex items-center space-x-6">
                    <div class="text-center">
                        <div class="text-3xl md:text-4xl font-bold text-white" id="completedCount">0</div>
                        <div class="text-base text-blue-200">已完成</div>
                    </div>
                    <div class="relative w-16 h-16 md:w-20 md:h-20">
                        <svg class="progress-ring w-full h-full" viewBox="0 0 120 120">
                            <circle class="progress-ring-circle stroke-white/20" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
                            <circle class="progress-ring-circle stroke-green-400" stroke-width="8" fill="transparent" r="52" cx="60" cy="60" stroke-dasharray="326.73" stroke-dashoffset="326.73" id="progressCircle"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-white font-bold text-sm" id="progressPercent">0%</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-green-500/20 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-green-300" id="completedTasks">0</div>
                    <div class="text-green-200 text-base">已完成</div>
                </div>
                <div class="bg-yellow-500/20 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-yellow-300" id="inProgressTasks">0</div>
                    <div class="text-yellow-200 text-base">進行中</div>
                </div>
                <div class="bg-blue-500/20 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-blue-300" id="notStartedTasks">31</div>
                    <div class="text-blue-200 text-base">未開始</div>
                </div>
                <div class="bg-purple-500/20 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-purple-300" id="totalTasks">26</div>
                    <div class="text-purple-200 text-base">必修關卡</div>
                </div>
            </div>
        </div>
        <div class="mb-8">
            <h3 class="text-xl font-semibold text-white mb-4">任務分類</h3>
            <div class="flex flex-wrap gap-2" id="categoryFilters">
                <button type="button" class="category-filter active bg-white/10 backdrop-blur-lg px-4 py-2 rounded-full text-white text-base font-medium border border-white/20" data-category="all">全部 (26必修+5選修)</button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="taskContainer"></div>
        <div id="celebrationModal" class="fixed inset-0 bg-black/50 modal-overlay hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center transform scale-95 transition-transform">
                <div class="text-6xl mb-4">🎉</div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">恭喜完成任務！</h3>
                <p class="text-gray-600 mb-6" id="celebrationText">你已經完成了一個重要的里程碑！</p>
                <button type="button" id="closeCelebrationBtn" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all">繼續加油！</button>
            </div>
        </div>
    </div>

    <div id="adminLoginScreen" class="min-h-screen items-center justify-center px-4 hidden">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full border border-white/20">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">🔐 導師登入</h1>
                <p class="text-blue-300">請輸入導師密碼</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-white text-sm font-medium mb-2">導師密碼</label>
                    <input type="password" id="adminPassword" required class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="請輸入導師密碼">
                </div>
                <button type="button" id="adminLoginBtn" class="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white py-3 rounded-lg font-semibold hover:from-red-700 hover:to-orange-700 transition-all">登入導師後台</button>
            </div>
            <div class="mt-6 text-center">
                <button type="button" id="hideAdminBtn" class="text-blue-300 hover:text-blue-200 text-sm underline">返回導生登入</button>
            </div>
        </div>
    </div>

    <div id="adminPanelScreen" class="min-h-screen px-4 py-8 hidden">
        <div class="container mx-auto max-w-6xl">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">🔐 導師後台</h1>
                <p class="text-blue-300">BNI雲貴分會新手村管理系統</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <button type="button" id="showAddMemberBtn" class="bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-lg font-semibold transition-all">➕ 新增導生</button>
                <button type="button" id="showMemberListBtn" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg font-semibold transition-all">📊 導生排行榜</button>
                <button type="button" id="showMemberMgmtBtn" class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg font-semibold transition-all">👥 導生管理</button>
                <button type="button" id="showPasswordSettingsBtn" class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg font-semibold transition-all">🔑 密碼設定</button>
            </div>
            <div id="addMemberSection" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/20 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">新增導生</h2>
                    <button type="button" class="hide-section-btn px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm transition-all">收起</button>
                </div>
                <div class="space-y-4">
                    <div class="bg-white/5 rounded-lg p-4">
                        <h3 class="text-white font-semibold mb-3">建立新導生帳號</h3>
                        <div class="space-y-3">
                            <input type="text" id="newMemberName" placeholder="導生姓名" required class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <input type="text" id="newMemberIndustry" placeholder="行業別 (選填)" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <input type="password" id="newMemberPassword" placeholder="設定密碼 (選填，留空表示無密碼)" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <button type="button" id="createMemberBtn" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded-lg font-semibold transition-all">建立導生</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="memberRankingSection" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/20 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">導生排行榜</h2>
                    <button type="button" class="hide-section-btn px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm transition-all">收起</button>
                </div>
                <div class="space-y-3" id="adminRankingList"></div>
            </div>
            <div id="memberManagementSection" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/20 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">導生管理</h2>
                    <button type="button" class="hide-section-btn px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm transition-all">收起</button>
                </div>
                <div id="adminManagementList"></div>
            </div>
            <div id="passwordSettingsSection" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/20 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">密碼設定</h2>
                    <button type="button" class="hide-section-btn px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm transition-all">收起</button>
                </div>
                <div class="space-y-4">
                    <div class="bg-white/5 rounded-lg p-4">
                        <h3 class="text-white font-semibold mb-3">更改導師密碼</h3>
                        <div class="space-y-3">
                            <input type="password" id="oldAdminPassword" placeholder="輸入舊密碼" required class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <input type="password" id="newAdminPassword" placeholder="輸入新密碼" required class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <button type="button" id="changePasswordBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-semibold transition-all">更改密碼</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center space-y-4">
                <button type="button" id="clearAllDataBtn" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-all">⚠️ 清除所有資料</button>
                <p class="text-red-300 text-sm">注意：此操作將清除所有導生的進度資料，無法復原！</p>
                <button type="button" id="hideAdminPanelBtn" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition-all">返回登入頁面</button>
            </div>
        </div>
    </div>
    <div id="memberTaskModal" class="fixed inset-0 bg-black/50 modal-overlay hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 max-w-4xl max-h-[80vh] overflow-y-auto mx-4 w-full" id="memberTaskModalContentWrapper">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="memberTaskModalTitle">導生任務管理</h3>
                <button type="button" id="closeMemberTaskBtn" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
            </div>
            <div id="memberTaskModalContent"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        (function() {
            'use strict';
            
            const SUPABASE_URL = 'https://hdssnsnkagfjfbuvgfkn.supabase.co'; 
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhkc3Nuc25rYWdmamZidXZnZmtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MjAyMDksImV4cCI6MjA3MzE5NjIwOX0.UoSKuEbguyE-I2j8gRO_mclOffwkV6WFLwayjrkFsuY'; 
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            let currentMember = null;
            let tasks = []; 
            
            const tasksTemplate = [
                { id: 1, title: "新手包", description: "收到區域寄送的導生新手包", icon: "📦", difficulty: "基礎", reward: "新手資料包", category: "入門準備", completionCondition: "收到區域寄送的導生新手包", isRequired: true },
                { id: 2, title: "名牌", description: "製作個人專屬的BNI名牌", icon: "🏷️", difficulty: "基礎", reward: "個人名牌", category: "入門準備", completionCondition: "製作名牌", isRequired: true },
                { id: 3, title: "參加25s專業簡報培訓", description: "觀看25秒專業簡報教學影片", icon: "🎤", difficulty: "基礎", reward: "簡報技能", category: "影片培訓", completionCondition: "觀看教學影片", videoUrl: "https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf", isRequired: true },
                { id: 4, title: "【導師考核】每周25s專業簡報", description: "通過導師考核，展示25秒專業簡報能力", icon: "✅", difficulty: "考核", reward: "簡報認證", category: "導師考核", completionCondition: "導師考核", isRequired: true },
                { id: 5, title: "【導師考核】25秒自我介紹及Slogan", description: "完成25秒自我介紹和個人Slogan展示", icon: "🗣️", difficulty: "考核", reward: "自我介紹認證", category: "導師考核", completionCondition: "導師考核", isRequired: true },
                { id: 6, title: "參加Connect系統開通&操作培訓", description: "觀看Connect系統教學影片(共2部)", icon: "💻", difficulty: "基礎", reward: "系統操作技能", category: "影片培訓", completionCondition: "觀看教學影片", videoUrl: "https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf", isRequired: true },
                { id: 7, title: "【導師考核】Connect系統開通&操作", description: "通過Connect系統開通&操作考核", icon: "🔗", difficulty: "考核", reward: "系統操作認證", category: "導師考核", completionCondition: "導師考核", isRequired: true },
                { id: 8, title: "參加目標設定培訓", description: "觀看目標設定教學影片", icon: "🎯", difficulty: "基礎", reward: "目標規劃技能", category: "影片培訓", completionCondition: "觀看教學影片", videoUrl: "https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf", isRequired: true },
                { id: 9, title: "【導師考核】目標設定", description: "完成個人目標設定並通過導師考核", icon: "📊", difficulty: "考核", reward: "目標設定認證", category: "導師考核", completionCondition: "導師考核", isRequired: true },
                { id: 10, title: "參加人脈合作變現表培訓", description: "觀看人脈合作變現表教學影片", icon: "💰", difficulty: "進階", reward: "變現技能", category: "影片培訓", completionCondition: "觀看教學影片", videoUrl: "https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf", isRequired: true },
                { id: 11, title: "【導師考核】人脈合作變現表", description: "完成人脈合作變現表並通過考核", icon: "💎", difficulty: "考核", reward: "變現表認證", category: "導師考核", completionCondition: "導師考核", isRequired: true },
                { id: 12, title: "新會員見面會", description: "參與每月一次由區域排定時間的新人見面會", icon: "🤝", difficulty: "基礎", reward: "人脈建立", category: "實體活動", completionCondition: "參與每月一次由區域排定時間的新人見面會(一個月只有一次很重要)", isRequired: true },
                { id: 13, title: "FB區域粉專按讚", description: "雲貴分會FB點讚", icon: "👍", difficulty: "基礎", reward: "社群連結", category: "社交活動", completionCondition: "雲貴分會FB點讚", fbUrl: "https://www.facebook.com/bni.yungui", isRequired: true },
                { id: 14, title: "初階MSP", description: "報名區域培訓課程(與進階MSP擇一即可)", icon: "📈", difficulty: "進階", reward: "初階MSP證書", category: "線上課程", completionCondition: "報名區域培訓課程(與15項擇一即可)", courseUrl: "https://ally.nime.com.tw/html/memberLogin", isRequired: true },
                { id: 15, title: "進階MSP", description: "報名區域培訓課程(與初階MSP擇一即可)", icon: "🚀", difficulty: "進階", reward: "進階MSP證書", category: "線上課程", completionCondition: "報名區域培訓課程(與14項擇一即可)", courseUrl: "https://ally.nime.com.tw/html/memberLogin", isRequired: true },
                { id: 16, title: "會員成功藍圖", description: "參與導師八周特定主題", icon: "🗺️", difficulty: "進階", reward: "成功藍圖", category: "導師八周", completionCondition: "參與導師八周特定主題", isRequired: true },
                { id: 17, title: "新會員護照", description: "參與導師八周特定主題", icon: "📘", difficulty: "進階", reward: "導生護照", category: "導師八周", completionCondition: "參與導師八周特定主題", isRequired: true },
                { id: 18, title: "導師八周", description: "參與4次每周四導師八周", icon: "🧙‍♂️", difficulty: "進階", reward: "導師指導完成證書", category: "導師八周", completionCondition: "參與4次每周四導師八周", weeklyTopics: "W1:導生成功藍圖/出席的重要性 W2:行政小組運作/明確目標 W3:新導生護照/告訴我們怎麼說 W4:邀約來賓心法與技巧/帶來小道具 W5:導生成功藍圖/非同凡響的見證 W6:行政小組運作/一對一會面 W7:新導生護照/為什麼要帶來賓 W8:邀約來賓心法與技巧/我們應該怎麼做", isRequired: true, isCountable: true, targetCount: 4 },
                { id: 19, title: "全國分享會", description: "參與每周一全國分享會1次", icon: "🌟", difficulty: "進階", reward: "全國視野", category: "大型活動", completionCondition: "參與每周一全國分享會1次", isRequired: true },
                { id: 20, title: "參加紅綠燈計算培訓", description: "觀看紅綠燈計算教學影片", icon: "🚦", difficulty: "進階", reward: "分析技能", category: "影片培訓", completionCondition: "觀看教學影片", videoUrl: "https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf", isRequired: true },
                { id: 21, title: "【導師考核】紅綠燈計算", description: "通過紅綠燈計算方法考核", icon: "📊", difficulty: "考核", reward: "分析認證", category: "導師考核", completionCondition: "導師考核", isRequired: true },
                { id: 22, title: "導師示範一對一", description: "邀約導師由導師示範一對一", icon: "👁️", difficulty: "進階", reward: "實戰經驗", category: "實戰學習", completionCondition: "邀約導師由導師示範一對一", isRequired: true },
                { id: 23, title: "參加1-1表格 1、2表培訓", description: "觀看1-1表格教學影片", icon: "📋", difficulty: "進階", reward: "表格技能", category: "影片培訓", completionCondition: "觀看教學影片", videoUrl: "https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf", isRequired: true },
                { id: 24, title: "【導師考核】完成1-1表格 1、2表", description: "完成1-1表格1、2表並通過考核", icon: "✍️", difficulty: "考核", reward: "表格認證", category: "導師考核", completionCondition: "導師考核", isRequired: true },
                { id: 25, title: "參加1-1表格 3、4表培訓", description: "觀看1-1表格教學影片", icon: "📄", difficulty: "進階", reward: "進階表格技能", category: "影片培訓", completionCondition: "觀看教學影片", videoUrl: "https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf", isRequired: true },
                { id: 26, title: "【導師考核】完成1-1表格 3、4表", description: "完成1-1表格3、4表並通過考核", icon: "📝", difficulty: "考核", reward: "進階表格認證", category: "導師考核", completionCondition: "導師考核", isRequired: true },
                { id: 27, title: "簡報工作坊(選修)", description: "報名區域培訓課程", icon: "🎪", difficulty: "選修", reward: "簡報專精技能", category: "選修課程", completionCondition: "報名區域培訓課程", courseUrl: "https://ally.nime.com.tw/html/memberLogin", isRequired: false },
                { id: 28, title: "一對一工作坊(選修)", description: "報名區域培訓課程", icon: "👥", difficulty: "選修", reward: "面談技能", category: "選修課程", completionCondition: "報名區域培訓課程", courseUrl: "https://ally.nime.com.tw/html/memberLogin", isRequired: false },
                { id: 29, title: "與導師一對一(選修)", description: "邀約導師進行一對一面談", icon: "🎯", difficulty: "選修", reward: "導師指導", category: "選修課程", completionCondition: "邀約導師一對一", isRequired: false },
                { id: 30, title: "與董顧大使一對一(選修)", description: "邀約董事顧問大使進行一對一面談", icon: "👔", difficulty: "選修", reward: "高階指導", category: "選修課程", completionCondition: "邀約董顧大使一對一", isRequired: false },
                { id: 31, title: "與九長一對一(選修)", description: "邀約九長進行一對一面談交流", icon: "🏆", difficulty: "選修", reward: "領導指導", category: "選修課程", completionCondition: "邀約九長一對一", isRequired: false }
            ];

            function getInitialTasksForDB() {
                return tasksTemplate.map(task => ({
                    id: task.id,
                    status: 'not-started',
                    currentCount: task.isCountable ? 0 : undefined
                }));
            }
            
            function loadTasksFromMemberData(memberTasksProgress) {
                if (!memberTasksProgress) memberTasksProgress = [];
                tasks = tasksTemplate.map(templateTask => {
                    const progress = memberTasksProgress.find(p => p.id === templateTask.id);
                    return {
                        ...templateTask,
                        status: progress ? progress.status : 'not-started',
                        currentCount: progress ? progress.currentCount : (templateTask.isCountable ? 0 : undefined),
                    };
                });
            }

            async function handleLogin() {
                const nameInput = document.getElementById('memberName');
                const passwordInput = document.getElementById('memberPassword');
                const name = nameInput.value.trim();
                const password = passwordInput.value;

                if (!name) return alert('請填寫導生姓名');

                const { data, error } = await supabaseClient.from('members').select('*').eq('name', name).single();

                if (error || !data) return alert('❌ 導生不存在或查詢失敗！');
                if (data.password && data.password !== password) return alert('密碼錯誤！');
                
                currentMember = data;
                sessionStorage.setItem('currentMemberId', currentMember.id);
                
                loadTasksFromMemberData(currentMember.tasks);
                updateMemberDisplay(currentMember.name);
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                generateCategoryFilters();
                renderTasks();
                updateProgress();
            }

            async function createMember() {
                const nameInput = document.getElementById('newMemberName');
                const industryInput = document.getElementById('newMemberIndustry');
                const passwordInput = document.getElementById('newMemberPassword');
                
                const name = nameInput.value.trim();
                if (!name) return alert('請填寫導生姓名');

                const { data: existingMember } = await supabaseClient.from('members').select('id').eq('name', name).single();
                if (existingMember) return alert('導生姓名已存在，請使用不同的姓名');

                const { error } = await supabaseClient.from('members').insert({
                    name: name,
                    industry: industryInput.value.trim() || 'BNI導生',
                    password: passwordInput.value || null,
                    tasks: getInitialTasksForDB()
                });

                if (error) {
                    alert('建立導生失敗：' + error.message);
                } else {
                    const passwordInfo = passwordInput.value ? `密碼：${passwordInput.value}` : '無密碼';
                    alert(`✅ 導生建立成功！\n\n姓名：${name}\n${passwordInfo}`);
                    nameInput.value = '';
                    industryInput.value = '';
                    passwordInput.value = '';
                }
            }
            
            async function saveTasksToDB() {
                if (!currentMember) return;
                
                const tasksProgressToSave = tasks.map(t => ({
                    id: t.id,
                    status: t.status,
                    currentCount: t.isCountable ? t.currentCount : undefined
                }));

                const { error } = await supabaseClient
                    .from('members')
                    .update({ tasks: tasksProgressToSave })
                    .eq('id', currentMember.id);
                
                if (error) {
                    console.error("Failed to save progress:", error);
                    alert("進度儲存失敗，請檢查網路連線。");
                }
            }
            
            function logout() {
                currentMember = null;
                sessionStorage.removeItem('currentMemberId');
                localStorage.removeItem('graduationCelebrated');
                
                document.getElementById('memberName').value = '';
                document.getElementById('memberPassword').value = '';
                
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('adminPanelScreen').classList.add('hidden');
                document.getElementById('adminLoginScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                
                showLoginRanking();
            }
            
            async function checkSession() {
                const memberId = sessionStorage.getItem('currentMemberId');
                if (memberId) {
                    const { data, error } = await supabaseClient.from('members').select('*').eq('id', parseInt(memberId)).single();
                    if (data && !error) {
                        currentMember = data;
                        loadTasksFromMemberData(currentMember.tasks);
                        updateMemberDisplay(currentMember.name);
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('mainContent').classList.remove('hidden');
                        generateCategoryFilters();
                        renderTasks();
                        updateProgress();
                    } else {
                        sessionStorage.removeItem('currentMemberId');
                    }
                }
            }
            
            let currentFilter = 'all';

            function updateTaskStatus(taskId, newStatus) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    const oldStatus = task.status;
                    task.status = newStatus;
                    if (task.isCountable && newStatus === 'not-started') task.currentCount = 0;
                    if (oldStatus !== 'completed' && newStatus === 'completed') showCelebration(task.title);
                    renderTasks();
                    updateProgress();
                    saveTasksToDB();
                }
            }

            function incrementCount(taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task && task.isCountable && (task.currentCount || 0) < task.targetCount) {
                    task.currentCount = (task.currentCount || 0) + 1;
                    if (task.currentCount === 1 && task.status === 'not-started') task.status = 'in-progress';
                    if (task.currentCount === task.targetCount) {
                        task.status = 'completed';
                        showCelebration(task.title);
                    }
                    renderTasks();
                    updateProgress();
                    saveTasksToDB();
                }
            }

            function decrementCount(taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task && task.isCountable && (task.currentCount || 0) > 0) {
                    task.currentCount--;
                    if (task.currentCount === 0) task.status = 'not-started';
                    else if (task.currentCount < task.targetCount) task.status = 'in-progress';
                    renderTasks();
                    updateProgress();
                    saveTasksToDB();
                }
            }
            
            function updateMemberDisplay(name) {
                document.getElementById('displayMemberName').textContent = name;
                document.getElementById('memberAvatar').textContent = name.charAt(0).toUpperCase();
            }

            async function showLoginRanking() {
                const { data: members, error } = await supabaseClient.from('members').select('name, industry, created_at, tasks');
                if (error) {
                    console.error("Error fetching members for ranking:", error);
                    return;
                }
                
                const ranking = [];
                const graduated = [];

                members.forEach(member => {
                    const progress = calculateMemberProgress(member.tasks);
                    const memberData = { name: member.name, industry: member.industry, joinDate: member.created_at, ...progress };
                    if (progress.percentage >= 100) graduated.push(memberData);
                    else ranking.push(memberData);
                });

                ranking.sort((a, b) => b.percentage - a.percentage || b.completedCount - a.completedCount);
                graduated.sort((a, b) => new Date(a.joinDate) - new Date(b.joinDate));
                
                const graduatedSection = document.getElementById('graduatedMembersSection');
                const graduatedList = document.getElementById('graduatedMembersList');
                if (graduated.length > 0) {
                    graduatedList.innerHTML = graduated.map(member => {
                        const joinDate = new Date(member.joinDate).toLocaleDateString('zh-TW');
                        return `<div class="bg-gradient-to-r from-yellow-500/30 to-orange-500/30 rounded-lg p-4 border border-yellow-400/50"><div class="flex items-center space-x-3"><div class="w-12 h-12 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-full flex items-center justify-center text-white font-bold">${member.name.charAt(0).toUpperCase()}</div><div class="flex-1"><h3 class="text-yellow-100 font-semibold text-lg">${member.name}</h3><p class="text-yellow-200 text-sm">${member.industry}</p><p class="text-yellow-300 text-xs">出村日期：${joinDate}</p></div><div class="text-3xl">🎓</div></div></div>`;
                    }).join('');
                    graduatedSection.classList.remove('hidden');
                } else {
                    graduatedSection.classList.add('hidden');
                }

                const rankingSection = document.getElementById('loginRankingSection');
                const rankingList = document.getElementById('loginRankingList');
                if (ranking.length > 0) {
                    rankingList.innerHTML = ranking.slice(0, 10).map((member, index) => {
                        const rankIcon = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}`;
                        const joinDate = new Date(member.joinDate).toLocaleDateString('zh-TW');
                        return `<div class="bg-white/5 rounded-lg p-4 flex items-center justify-between hover:bg-white/10 transition-all"><div class="flex items-center space-x-4"><div class="text-2xl font-bold text-white w-8 text-center">${rankIcon}</div><div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">${member.name.charAt(0).toUpperCase()}</div><div><h3 class="text-white font-semibold">${member.name}</h3><p class="text-blue-200 text-sm">${member.industry}</p><p class="text-blue-300 text-xs">加入：${joinDate}</p></div></div><div class="text-right"><div class="text-2xl font-bold text-white">${member.percentage}%</div><div class="text-blue-200 text-sm">${member.completedCount}/${member.totalCount} 必修</div><div class="text-blue-300 text-xs">完成${member.completed} | 進行${member.inProgress}</div></div></div>`;
                    }).join('');
                    if (ranking.length > 10) rankingList.innerHTML += `<div class="text-center text-blue-300 text-sm py-2">還有 ${ranking.length - 10} 位導生未顯示...</div>`;
                    rankingSection.classList.remove('hidden');
                } else if (graduated.length === 0) {
                    rankingList.innerHTML = '<div class="text-center text-blue-300 py-8">目前還沒有導生資料</div>';
                    rankingSection.classList.remove('hidden');
                } else {
                    rankingSection.classList.add('hidden');
                }
            }
            
            function calculateMemberProgress(memberTasks) {
                if (!memberTasks) return { completedCount: 0, totalCount: 0, percentage: 0, completed: 0, inProgress: 0 };
                let requiredCompletedCount = 0, requiredTotalCount = 0, mspProcessed = false;
                const completed = memberTasks.filter(t => t.status === 'completed').length;
                const inProgress = memberTasks.filter(t => t.status === 'in-progress').length;
                tasksTemplate.filter(t => t.isRequired).forEach(task => {
                    const memberTask = memberTasks.find(mt => mt.id === task.id);
                    if (task.id === 14 || task.id === 15) {
                        if (!mspProcessed) {
                            requiredTotalCount++;
                            if (memberTasks.some(mt => (mt.id === 14 || mt.id === 15) && mt.status === 'completed')) requiredCompletedCount++;
                            mspProcessed = true;
                        }
                    } else if (task.isCountable) {
                        requiredTotalCount++;
                        requiredCompletedCount += (memberTask?.currentCount || 0) / task.targetCount;
                    } else {
                        requiredTotalCount++;
                        if (memberTask?.status === 'completed') requiredCompletedCount++;
                    }
                });
                const percentage = requiredTotalCount > 0 ? Math.round((requiredCompletedCount / requiredTotalCount) * 100) : 0;
                return { completedCount: Math.floor(requiredCompletedCount), totalCount: requiredTotalCount, percentage, completed, inProgress };
            }

            function generateCategoryFilters() {
                const categories = [...new Set(tasksTemplate.map(task => task.category))];
                const container = document.getElementById('categoryFilters');
                const allButton = container.querySelector('[data-category="all"]');
                container.innerHTML = '';
                container.appendChild(allButton);
                const requiredCount = tasksTemplate.filter(t => t.isRequired).length;
                const optionalCount = tasksTemplate.filter(t => !t.isRequired).length;
                allButton.textContent = `全部 (${requiredCount - 1}必修+${optionalCount}選修)`;
                categories.forEach(category => {
                    const count = tasksTemplate.filter(task => task.category === category).length;
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'category-filter bg-white/10 backdrop-blur-lg px-4 py-2 rounded-full text-white text-base font-medium border border-white/20';
                    button.setAttribute('data-category', category);
                    button.textContent = `${category} (${count})`;
                    button.addEventListener('click', () => filterTasks(category));
                    container.appendChild(button);
                });
            }
            function filterTasks(category) {
                currentFilter = category;
                document.querySelectorAll('.category-filter').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-category="${category}"]`).classList.add('active');
                renderTasks();
            }
            function renderTasks() {
                const container = document.getElementById('taskContainer');
                container.innerHTML = '';
                const filteredTasks = currentFilter === 'all' ? tasks : tasks.filter(task => task.category === currentFilter);
                filteredTasks.forEach(task => {
                    const statusClass = task.status === 'completed' ? 'completed' : task.status === 'in-progress' ? 'in-progress' : 'not-started';
                    const statusText = task.status === 'completed' ? '已完成' : task.status === 'in-progress' ? '進行中' : '未開始';
                    const statusIcon = task.status === 'completed' ? '✅' : task.status === 'in-progress' ? '⏳' : '⭕';
                    const difficultyColor = task.difficulty === '基礎' ? 'text-green-400' : task.difficulty === '進階' ? 'text-yellow-400' : task.difficulty === '考核' ? 'text-red-400' : task.difficulty === '選修' ? 'text-purple-400' : 'text-orange-400';
                    const countDisplay = task.isCountable ? `<div class="bg-blue-500/20 rounded-lg p-2 mb-3"><div class="flex items-center justify-between"><span class="text-xs text-blue-300">進度</span><span class="text-sm font-bold text-blue-200">${task.currentCount || 0}/${task.targetCount}</span></div><div class="w-full bg-white/10 rounded-full h-2 mt-1"><div class="bg-blue-400 h-2 rounded-full transition-all" style="width: ${((task.currentCount || 0) / task.targetCount) * 100}%"></div></div></div>` : '';
                    const card = document.createElement('div');
                    card.className = `task-card bg-white/10 backdrop-blur-lg rounded-2xl p-5 border border-white/20 ${statusClass}`;
                    card.innerHTML = `
                        <div class="flex items-start justify-between mb-3"><div class="text-3xl">${task.icon}</div><div class="flex items-center space-x-2"><span class="text-sm ${statusIcon === '✅' ? 'text-green-300' : statusIcon === '⏳' ? 'text-yellow-300' : 'text-blue-300'}">${statusIcon}</span><span class="text-xs ${statusIcon === '✅' ? 'text-green-300' : statusIcon === '⏳' ? 'text-yellow-300' : 'text-blue-300'}">${statusText}</span></div></div>
                        <h3 class="text-xl font-semibold text-white mb-2 leading-tight">${task.title}</h3> <p class="text-blue-200 mb-3 text-base leading-relaxed">${task.description}</p> ${countDisplay}
                        <div class="flex items-center justify-between mb-3"><span class="text-sm ${difficultyColor} font-medium px-2 py-1 bg-white/10 rounded">${task.difficulty}</span><span class="text-sm text-purple-300">🎁 ${task.reward}</span></div>
                        <div class="text-sm text-blue-300 mb-3">${task.category}</div>
                        <div class="bg-white/5 rounded-lg p-3 mb-3">
                            <div class="text-sm text-gray-300 mb-1">完成條件：</div><div class="text-sm text-white">${task.completionCondition}</div>
                            ${task.videoUrl ? `<div class="mt-2"><button type="button" class="external-link-btn inline-flex items-center text-sm text-blue-300 hover:text-blue-200" data-url="${task.videoUrl}">📹 觀看教學影片</button></div>` : ''}
                            ${task.fbUrl ? `<div class="mt-2"><button type="button" class="external-link-btn inline-flex items-center text-sm text-blue-300 hover:text-blue-200" data-url="${task.fbUrl}">👍 前往FB粉專</button></div>` : ''}
                            ${task.courseUrl ? `<div class="mt-2"><button type="button" class="external-link-btn inline-flex items-center text-sm text-blue-300 hover:text-blue-200" data-url="${task.courseUrl}">📚 前往課程報名</button></div>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            ${task.category === '導師考核' ? `<div class="flex-1 text-center py-2 px-3 bg-orange-600/50 text-orange-200 rounded-lg text-base">⚠️ 僅導師可操作</div>` : task.isCountable ? `${(task.currentCount || 0) < task.targetCount ? `<button type="button" class="increment-btn flex-1 py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium" data-task-id="${task.id}">+1 次參與</button>` : ''}${(task.currentCount || 0) > 0 ? `<button type="button" class="decrement-btn py-2 px-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium" data-task-id="${task.id}">-1</button>` : ''}` : `${task.status !== 'completed' ? `<button type="button" class="update-status-btn flex-1 py-2 px-3 rounded-lg font-medium ${task.status === 'not-started' ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white'}" data-task-id="${task.id}" data-new-status="${task.status === 'not-started' ? 'in-progress' : 'completed'}">${task.status === 'not-started' ? '開始' : '完成'}</button>` : ''}${task.status !== 'not-started' ? `<button type="button" class="reset-status-btn py-2 px-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium" data-task-id="${task.id}">重置</button>` : ''}`}
                        </div>`;
                    container.appendChild(card);
                });
                bindTaskEvents();
            }
            function bindTaskEvents() {
                document.querySelectorAll('.external-link-btn').forEach(btn => btn.addEventListener('click', function(e) { e.stopPropagation(); openExternalLink(this.dataset.url); }));
                document.querySelectorAll('.increment-btn').forEach(btn => btn.addEventListener('click', function(e) { e.stopPropagation(); incrementCount(parseInt(this.dataset.taskId)); }));
                document.querySelectorAll('.decrement-btn').forEach(btn => btn.addEventListener('click', function(e) { e.stopPropagation(); decrementCount(parseInt(this.dataset.taskId)); }));
                document.querySelectorAll('.update-status-btn').forEach(btn => btn.addEventListener('click', function(e) { e.stopPropagation(); updateTaskStatus(parseInt(this.dataset.taskId), this.dataset.newStatus); }));
                document.querySelectorAll('.reset-status-btn').forEach(btn => btn.addEventListener('click', function(e) { e.stopPropagation(); updateTaskStatus(parseInt(this.dataset.taskId), 'not-started'); }));
            }
            function showCelebration(taskTitle) {
                const modal = document.getElementById('celebrationModal');
                modal.querySelector('h3').textContent = '恭喜完成任務！';
                modal.querySelector('.text-6xl').textContent = '🎉';
                modal.querySelector('#celebrationText').textContent = `你已經完成了「${taskTitle}」任務！`;
                modal.querySelector('button').textContent = '繼續加油！';
                modal.classList.add('flex');
                modal.classList.remove('hidden');
                setTimeout(() => { modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10);
            }
            function closeCelebration() {
                const modal = document.getElementById('celebrationModal');
                modal.querySelector('div').classList.remove('scale-100');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 200);
            }
            function showGraduationCelebration() {
                const modal = document.getElementById('celebrationModal');
                modal.querySelector('h3').textContent = '🎊 恭喜出村！🎊';
                modal.querySelector('.text-6xl').textContent = '🏆';
                modal.querySelector('#celebrationText').textContent = '恭喜你完成了BNI雲貴分會新手村的所有必修任務！';
                modal.querySelector('button').textContent = '繼續加油！';
                modal.classList.add('flex');
                modal.classList.remove('hidden');
                setTimeout(() => { modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10);
            }
            function updateProgress() {
                const completed = tasks.filter(t => t.status === 'completed').length;
                const inProgress = tasks.filter(t => t.status === 'in-progress').length;
                const notStarted = tasks.filter(t => t.status === 'not-started').length;
                const progress = calculateMemberProgress(tasks);
                document.getElementById('completedCount').textContent = `${progress.completedCount}/${progress.totalCount}`;
                document.getElementById('completedTasks').textContent = completed;
                document.getElementById('inProgressTasks').textContent = inProgress;
                document.getElementById('notStartedTasks').textContent = notStarted;
                document.getElementById('progressPercent').textContent = progress.percentage + '%';
                const circle = document.getElementById('progressCircle');
                const circumference = 2 * Math.PI * 52;
                const offset = circumference - (progress.percentage / 100) * circumference;
                circle.style.strokeDashoffset = offset;
                if (progress.percentage === 100 && !localStorage.getItem('graduationCelebrated')) {
                    setTimeout(() => { showGraduationCelebration(); localStorage.setItem('graduationCelebrated', 'true'); }, 1000);
                }
            }
            
            function openExternalLink(url) {
                window.open(url, '_blank', 'noopener,noreferrer');
            }

            function getAdminPassword() { return localStorage.getItem('adminPassword') || 'bni2025'; }
            function setAdminPassword(newPassword) { localStorage.setItem('adminPassword', newPassword); }
            function showAdminLogin() { document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('adminLoginScreen').classList.add('flex'); document.getElementById('adminLoginScreen').classList.remove('hidden');}
            function hideAdminLogin() { document.getElementById('adminLoginScreen').classList.add('hidden'); document.getElementById('adminLoginScreen').classList.remove('flex'); document.getElementById('loginScreen').classList.remove('hidden'); document.getElementById('adminPassword').value = ''; }
            function handleAdminLogin() {
                const password = document.getElementById('adminPassword').value;
                if (password === getAdminPassword()) {
                    document.getElementById('adminLoginScreen').classList.add('hidden');
                    document.getElementById('adminLoginScreen').classList.remove('flex');
                    document.getElementById('adminPassword').value = '';
                    showAdminPanel();
                } else {
                    alert('密碼錯誤');
                    document.getElementById('adminPassword').value = '';
                }
            }
            function showAdminPanel() { document.getElementById('adminPanelScreen').classList.remove('hidden'); hideAdminSections(); }
            function hideAdminPanel() { document.getElementById('adminPanelScreen').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); showLoginRanking(); }
            function hideAdminSections() {
                document.getElementById('addMemberSection').classList.add('hidden');
                document.getElementById('memberRankingSection').classList.add('hidden');
                document.getElementById('memberManagementSection').classList.add('hidden');
                document.getElementById('passwordSettingsSection').classList.add('hidden');
            }
            function showAddMember() { hideAdminSections(); document.getElementById('addMemberSection').classList.remove('hidden'); }
            
            async function showMemberList() {
                hideAdminSections();
                const container = document.getElementById('adminRankingList');
                container.innerHTML = `<div class="text-white text-center p-8">正在從雲端載入排行榜...</div>`;
                document.getElementById('memberRankingSection').classList.remove('hidden');

                const { data: members, error } = await supabaseClient.from('members').select('id, name, industry, created_at, tasks');
                if (error) {
                    container.innerHTML = `<div class="text-red-400 text-center p-8">載入失敗: ${error.message}</div>`;
                    return;
                }

                const ranking = [];
                const graduated = [];
                members.forEach(member => {
                    const progress = calculateMemberProgress(member.tasks);
                    const memberData = { id: member.id, name: member.name, industry: member.industry, joinDate: member.created_at, ...progress };
                    if (progress.percentage >= 100) graduated.push(memberData);
                    else ranking.push(memberData);
                });
                ranking.sort((a, b) => b.percentage - a.percentage || b.completedCount - a.completedCount);
                graduated.sort((a, b) => new Date(a.joinDate) - new Date(b.joinDate));

                let html = '';
                if (graduated.length > 0) {
                     html += `<h3 class="text-lg font-semibold text-yellow-300 mb-3">🏆 已出村導生 (${graduated.length}位)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${graduated.map(member => `
                            <div class="bg-gradient-to-r from-yellow-500/20 to-orange-500/20 rounded-lg p-3 border border-yellow-400/30">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-full flex items-center justify-center text-white font-bold text-sm">${member.name.charAt(0).toUpperCase()}</div>
                                    <div><h4 class="text-yellow-200 font-semibold text-sm">${member.name}</h4><p class="text-yellow-300 text-xs">加入：${new Date(member.joinDate).toLocaleDateString('zh-TW')}</p></div>
                                    <div class="ml-auto text-yellow-300 text-lg">🎓</div>
                                </div>
                            </div>`).join('')}
                        </div>`;
                }
                if (ranking.length === 0 && graduated.length === 0) {
                     html += '<div class="text-center text-blue-300 py-8">目前沒有任何導生資料</div>';
                } else if (ranking.length > 0) {
                     html += `<h3 class="text-lg font-semibold text-white mt-6 mb-3">📊 進行中導生排行榜 (${ranking.length}位)</h3>
                        <div class="space-y-3">
                        ${ranking.map((member, index) => {
                             const rankIcon = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}`;
                             return `
                                <div class="bg-white/5 rounded-lg p-4 flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="text-2xl font-bold text-white w-8 text-center">${rankIcon}</div>
                                        <div>
                                            <h3 class="text-white font-semibold">${member.name}</h3>
                                            <p class="text-blue-200 text-sm">${member.industry}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold text-white">${member.percentage}%</div>
                                        <div class="text-blue-200 text-sm">${member.completedCount}/${member.totalCount} 必修</div>
                                    </div>
                                </div>`;
                         }).join('')}
                        </div>`;
                }
                container.innerHTML = html;
            }
            
            async function showMemberManagement() {
                hideAdminSections();
                const container = document.getElementById('adminManagementList');
                container.innerHTML = `<div class="text-white text-center p-8">正在從雲端載入導生列表...</div>`;
                document.getElementById('memberManagementSection').classList.remove('hidden');

                const { data: members, error } = await supabaseClient.from('members').select('*').order('created_at', { ascending: false });
                if (error) {
                    container.innerHTML = `<div class="text-red-400 text-center p-8">載入失敗: ${error.message}</div>`;
                    return;
                }

                if (members.length === 0) {
                     container.innerHTML = '<div class="text-center text-blue-300 py-8">目前沒有任何導生資料</div>';
                     return;
                }

                container.innerHTML = members.map(member => {
                    const progress = calculateMemberProgress(member.tasks);
                    const hasPassword = member.password ? '🔒' : '🔓';
                    const statusBadge = progress.percentage >= 100 
                        ? '<span class="bg-yellow-500 text-yellow-900 px-2 py-1 rounded-full text-xs font-semibold">🎓 已出村</span>'
                        : `<span class="bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-semibold">${progress.percentage}% 進行中</span>`;
                    
                    return `
                        <div class="bg-white/5 rounded-lg p-4 mb-3">
                            <div class="flex flex-col sm:flex-row items-center justify-between">
                                <div class="flex items-center space-x-3 mb-3 sm:mb-0">
                                    <div>
                                        <div class="flex items-center space-x-2 mb-1">
                                            <h3 class="text-white font-semibold">${member.name} ${hasPassword}</h3>
                                            ${statusBadge}
                                        </div>
                                        <p class="text-blue-200 text-sm">${member.industry}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button type="button" onclick="showMemberTasksModal(${member.id})" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">管理任務</button>
                                    <button type="button" onclick="resetMemberPassword(${member.id}, '${member.name}')" class="px-3 py-1 bg-orange-600 hover:bg-orange-700 text-white rounded text-sm">重設密碼</button>
                                    <button type="button" onclick="deleteMember(${member.id}, '${member.name}')" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm">刪除導生</button>
                                </div>
                            </div>
                        </div>`;
                }).join('');
            }

            async function deleteMember(memberId, memberName) {
                if (confirm(`⚠️ 確定要刪除導生 ${memberName} 嗎？\n此操作將永久刪除雲端資料，無法復原！`)) {
                    const { error } = await supabaseClient.from('members').delete().eq('id', memberId);
                    if (error) {
                        alert(`刪除失敗：${error.message}`);
                    } else {
                        alert(`導生 ${memberName} 已成功刪除。`);
                        showMemberManagement();
                    }
                }
            }
            window.deleteMember = deleteMember;

            async function resetMemberPassword(memberId, memberName) {
                const newPassword = prompt(`請為 ${memberName} 設定新密碼：\n（留空表示移除密碼，使用者將無需密碼即可登入）`);
                if (newPassword !== null) {
                    const { error } = await supabaseClient.from('members').update({ password: newPassword || null }).eq('id', memberId);
                    if (error) {
                         alert(`密碼重設失敗：${error.message}`);
                    } else {
                         alert(`導生 ${memberName} 的密碼已成功更新。`);
                         showMemberManagement();
                    }
                }
            }
            window.resetMemberPassword = resetMemberPassword;

            let currentlyEditingMember = null;
            
            function _renderAdminTasks(member, container) {
                let memberTasksProgress = member.tasks || [];
                container.innerHTML = tasksTemplate.map(taskTpl => {
                    const taskProgress = memberTasksProgress.find(p => p.id === taskTpl.id) || { id: taskTpl.id, status: 'not-started', currentCount: 0 };
                    const statusOptions = ['not-started', 'in-progress', 'completed']
                        .map(s => `<option value="${s}" ${taskProgress.status === s ? 'selected' : ''}>${s === 'not-started' ? '未開始' : s === 'in-progress' ? '進行中' : '已完成'}</option>`)
                        .join('');
                    const countControls = taskTpl.isCountable
                        ? `<div class="flex items-center space-x-2">
                                <button class="px-2 py-1 bg-gray-300 text-gray-800 rounded hover:bg-gray-400" onclick="adminUpdateTask(${member.id}, ${taskTpl.id}, null, ${Math.max(0, (taskProgress.currentCount || 0) - 1)})">-</button>
                                <span>${taskProgress.currentCount || 0} / ${taskTpl.targetCount}</span>
                                <button class="px-2 py-1 bg-gray-300 text-gray-800 rounded hover:bg-gray-400" onclick="adminUpdateTask(${member.id}, ${taskTpl.id}, null, ${Math.min(taskTpl.targetCount, (taskProgress.currentCount || 0) + 1)})">+</button>
                           </div>` : '';
                    return `<div class="border rounded-lg p-3 mb-2 flex justify-between items-center bg-gray-50">
                            <div class="flex-1"><h4 class="font-semibold text-gray-800">${taskTpl.icon} ${taskTpl.title}</h4></div>
                            <div class="flex items-center space-x-4">${countControls}
                                <select class="text-xs border rounded px-2 py-1" onchange="adminUpdateTask(${member.id}, ${taskTpl.id}, this.value, null)">${statusOptions}</select>
                            </div></div>`;
                }).join('');
            }

            async function showMemberTasksModal(memberId) {
                const modal = document.getElementById('memberTaskModal');
                const title = document.getElementById('memberTaskModalTitle');
                const content = document.getElementById('memberTaskModalContent');
                
                content.innerHTML = `<div class="text-gray-800 text-center p-8">正在載入任務資料...</div>`;
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                const { data: member, error } = await supabaseClient.from('members').select('id, name, tasks').eq('id', memberId).single();
                if (error || !member) {
                    content.innerHTML = `<div class="text-red-500 text-center p-8">載入失敗: ${error.message}</div>`;
                    return;
                }
                
                currentlyEditingMember = member;
                title.textContent = `${member.name} - 任務管理`;
                _renderAdminTasks(member, content);
            }
            window.showMemberTasksModal = showMemberTasksModal;

            async function adminUpdateTask(memberId, taskId, newStatus, newCount) {
                if (!currentlyEditingMember || currentlyEditingMember.id !== memberId) return;

                const contentWrapper = document.getElementById('memberTaskModalContentWrapper');
                const scrollPosition = contentWrapper.scrollTop;
                
                const taskIndex = currentlyEditingMember.tasks.findIndex(t => t.id === taskId);
                
                if (taskIndex !== -1) {
                    const task = currentlyEditingMember.tasks[taskIndex];
                    if (newStatus !== null) task.status = newStatus;
                    if (newCount !== null) task.currentCount = newCount;
                    const taskTpl = tasksTemplate.find(t => t.id === taskId);
                    if (taskTpl.isCountable) {
                        if (task.currentCount > 0 && task.currentCount < taskTpl.targetCount) task.status = 'in-progress';
                        else if (task.currentCount >= taskTpl.targetCount) task.status = 'completed';
                        else task.status = 'not-started';
                    }
                } else {
                     currentlyEditingMember.tasks.push({ id: taskId, status: newStatus || 'not-started', currentCount: newCount });
                }

                const { error } = await supabaseClient
                    .from('members')
                    .update({ tasks: currentlyEditingMember.tasks })
                    .eq('id', memberId);

                if (error) {
                    alert('更新失敗: ' + error.message);
                } else {
                    _renderAdminTasks(currentlyEditingMember, document.getElementById('memberTaskModalContent'));
                    contentWrapper.scrollTop = scrollPosition;
                }
            }
            window.adminUpdateTask = adminUpdateTask;

            function closeMemberTaskModal() {
                const modal = document.getElementById('memberTaskModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                currentlyEditingMember = null;
                showMemberManagement();
            }

            function showPasswordSettings() { hideAdminSections(); document.getElementById('passwordSettingsSection').classList.remove('hidden'); }
            function changeAdminPassword() {
                const oldPassword = document.getElementById('oldAdminPassword').value;
                const newPassword = document.getElementById('newAdminPassword').value;
                if (oldPassword !== getAdminPassword()) return alert('舊密碼錯誤');
                if (newPassword.length < 6) return alert('新密碼至少需要6個字元');
                setAdminPassword(newPassword);
                alert('導師密碼已更新');
                document.getElementById('oldAdminPassword').value = '';
                document.getElementById('newAdminPassword').value = '';
            }
            async function clearAllData() {
                if (confirm('確定要清除所有雲端導生資料嗎？此操作無法復原！')) {
                    const { error } = await supabaseClient.from('members').delete().neq('id', 0);
                    if (error) alert("清除失敗：" + error.message);
                    else { alert('所有雲端資料已清除'); logout(); }
                }
            }
            
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('loginButton')?.addEventListener('click', handleLogin);
                document.getElementById('memberName')?.addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
                document.getElementById('memberPassword')?.addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
                document.getElementById('showAdminBtn')?.addEventListener('click', showAdminLogin);
                document.getElementById('hideAdminBtn')?.addEventListener('click', hideAdminLogin);
                document.getElementById('adminLoginBtn')?.addEventListener('click', handleAdminLogin);
                document.getElementById('adminPassword')?.addEventListener('keypress', e => { if (e.key === 'Enter') handleAdminLogin(); });
                document.getElementById('showAddMemberBtn')?.addEventListener('click', showAddMember);
                document.getElementById('createMemberBtn')?.addEventListener('click', createMember);
                document.getElementById('showMemberListBtn')?.addEventListener('click', showMemberList);
                document.getElementById('showMemberMgmtBtn')?.addEventListener('click', showMemberManagement);
                document.getElementById('showPasswordSettingsBtn')?.addEventListener('click', showPasswordSettings);
                document.getElementById('changePasswordBtn')?.addEventListener('click', changeAdminPassword);
                document.getElementById('clearAllDataBtn')?.addEventListener('click', clearAllData);
                document.getElementById('hideAdminPanelBtn')?.addEventListener('click', hideAdminPanel);
                document.querySelectorAll('.hide-section-btn').forEach(btn => btn.addEventListener('click', hideAdminSections));
                document.getElementById('logoutBtn')?.addEventListener('click', logout);
                document.getElementById('closeCelebrationBtn')?.addEventListener('click', closeCelebration);
                document.getElementById('closeMemberTaskBtn')?.addEventListener('click', closeMemberTaskModal);
                document.querySelector('[data-category="all"]')?.addEventListener('click', () => filterTasks('all'));
                
                const requiredTotal = tasksTemplate.filter(t => t.isRequired).length;
                document.getElementById('totalTasks').textContent = requiredTotal - 1;
                
                checkSession();
                showLoginRanking();
            });

        })();
    </script>
</body>
</html>

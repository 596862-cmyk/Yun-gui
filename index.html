<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNI雲貴分會 - 新手村任務系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        html { transition: font-size 0.2s ease-in-out; }
        body { font-family: 'Noto Sans TC', sans-serif; overflow-x: hidden; }
        .task-card { transition: all 0.3s ease; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .completed { background: linear-gradient(135deg, #10b981, #059669); }
        .in-progress { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .not-started { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-circle { transition: stroke-dashoffset 0.35s; }
        .category-filter { transition: all 0.3s ease; }
        .category-filter.active { background: linear-gradient(135deg, #8b5cf6, #7c3aed); transform: scale(1.05); }
        * { box-sizing: border-box; }
        .modal-overlay { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 min-h-screen">
    <div id="fontSizeController" class="fixed bottom-4 right-4 z-50 flex items-center space-x-2 bg-white/10 backdrop-blur-lg p-2 rounded-full border border-white/20">
        <button id="decreaseFont" class="w-10 h-10 flex items-center justify-center bg-white/10 text-white rounded-full hover:bg-white/20 transition-colors text-lg font-bold">A-</button>
        <button id="resetFont" class="w-10 h-10 flex items-center justify-center bg-white/10 text-white rounded-full hover:bg-white/20 transition-colors text-sm font-bold">A</button>
        <button id="increaseFont" class="w-10 h-10 flex items-center justify-center bg-white/10 text-white rounded-full hover:bg-white/20 transition-colors text-xl font-bold">A+</button>
    </div>

    <div id="loginScreen" class="min-h-screen px-4 py-8">
        <div class="container mx-auto max-w-6xl">
            <div class="flex justify-center mb-8">
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full border border-white/20">
                    <div class="text-center mb-8">
                        <h1 class="text-4xl font-bold text-white mb-2">🏢 BNI雲貴分會</h1>
                        <h2 class="text-2xl font-semibold text-blue-200 mb-4">新手村任務系統</h2>
                        <p class="text-lg text-blue-300">請輸入您的導生資訊</p>
                        <p class="text-sm text-yellow-300 mt-2">⚠️ 導生帳號由導師建立，無法自行註冊</p>
                    </div>
                    <div id="loginFormContainer">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-white text-base font-medium mb-2">導生姓名</label>
                                <input type="text" id="memberName" required class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 text-base" placeholder="請輸入您的姓名">
                            </div>
                            <div>
                                <label class="block text-white text-base font-medium mb-2">導生密碼</label>
                                <input type="password" id="memberPassword" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 text-base" placeholder="請輸入導師為您設定的密碼">
                            </div>
                            <button type="button" id="loginButton" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all text-lg">
                                開始我的新手村之旅
                            </button>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <button type="button" id="showAdminBtn" class="text-blue-300 hover:text-blue-200 text-sm underline">
                            導師登入
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex justify-center mb-8">
                 <button type="button" id="toggleGuestFormBtn" class="w-full max-w-md bg-teal-600/50 hover:bg-teal-500/50 text-white py-3 rounded-lg font-semibold transition-all text-lg">
                    📝 我要登記為來賓
                </button>
            </div>
            
            <div id="guestFormContainer" class="hidden">
                <div class="flex justify-center mb-8">
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full border border-white/20">
                        <h3 class="text-2xl font-semibold text-white mb-6 text-center">來賓登記表</h3>
                        <div class="space-y-4">
                             <input type="text" id="guestName" required class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="您的姓名">
                             <input type="text" id="guestProfession" required class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="您的專業別">
                             <input type="text" id="guestReferrer" required class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="介紹人">
                             <select id="guestInterest" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                 <option value="高">加入意願度：高</option>
                                 <option value="中">加入意願度：中</option>
                                 <option value="低">加入意願度：低</option>
                             </select>
                             <button type="button" id="submitGuestBtn" class="w-full bg-gradient-to-r from-teal-500 to-cyan-500 text-white py-3 rounded-lg font-semibold hover:from-teal-600 hover:to-cyan-600 transition-all">
                                 提交登記
                             </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="publicGuestListSection" class="mb-8">
                 <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 max-w-4xl mx-auto">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-white mb-2">👋 最新來賓</h2>
                    </div>
                    <div id="publicGuestListContainer" class="space-y-3">
                        </div>
                </div>
            </div>
            <div id="graduatedMembersSection" class="mb-8 hidden">
                <div class="bg-gradient-to-r from-yellow-500/20 to-orange-500/20 backdrop-blur-lg rounded-2xl p-6 border border-yellow-400/30">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-yellow-300 mb-2">🏆 已出村導生表揚 🏆</h2>
                        <p class="text-yellow-200">恭喜以下導生完成所有必修任務，成為BNI專業導生！</p>
                    </div>
                    <div id="graduatedMembersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>
            <div id="loginRankingSection" class="hidden">
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-white mb-2">📊 導生排行榜</h2>
                        <p class="text-blue-300">新手村任務完成進度排名</p>
                    </div>
                    <div id="loginRankingList" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="mainContent" class="container mx-auto px-4 py-8 hidden">
        </div>

    <div id="adminLoginScreen" class="min-h-screen items-center justify-center px-4 hidden">
        </div>

    <div id="adminPanelScreen" class="min-h-screen px-4 py-8 hidden">
        </div>
    
    <div id="memberTaskModal" class="fixed inset-0 bg-black/50 modal-overlay hidden items-center justify-center z-50">
        </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        (function() {
            'use strict';
            
            const SUPABASE_URL = 'https://hdssnsnkagfjfbuvgfkn.supabase.co'; 
            const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY'; // ★★★ 請記得換成您自己的 KEY ★★★
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            // ... (省略大量 JS 程式碼，僅顯示修改處) ...
            
            // ★★★ (修改) 來賓名單功能 JS START ★★★
            // ... (後台的 showGuestList 函式不變) ...
            
            async function showPublicGuestList() {
                const container = document.getElementById('publicGuestListContainer');
                if (!container) return;
                container.innerHTML = `<div class="text-white text-center p-4">正在載入最新來賓...</div>`;
                const { data: guests, error } = await supabaseClient.from('guests').select('id, name, profession, referrer, creator_token').order('created_at', { ascending: false }).limit(10);
                
                if (error) {
                    container.innerHTML = `<div class="text-red-400 text-center p-4">無法載入來賓列表</div>`;
                    return;
                }
                if (guests.length === 0) {
                    container.innerHTML = `<div class="text-center text-blue-300 py-4">目前還沒有來賓登記</div>`;
                    return;
                }

                const creatorToken = sessionStorage.getItem('guestCreatorToken');

                container.innerHTML = guests.map(guest => {
                    const deleteButton = (creatorToken && guest.creator_token === creatorToken)
                        ? `<button onclick="deleteGuest(${guest.id}, '${guest.name}')" class="text-red-400 hover:text-red-300 text-xl font-bold">&times;</button>`
                        : '';

                    return `
                    <div class="bg-white/5 rounded-lg p-3 flex items-center justify-between">
                        <div>
                            <p class="text-white font-semibold">${guest.name} <span class="text-sm font-normal text-gray-300">- ${guest.profession}</span></p>
                            <p class="text-xs text-blue-200">介紹人: ${guest.referrer}</p>
                        </div>
                        ${deleteButton}
                    </div>`;
                }).join('');
            }

            async function addGuest() {
                const name = document.getElementById('guestName').value.trim();
                const profession = document.getElementById('guestProfession').value.trim();
                const referrer = document.getElementById('guestReferrer').value.trim();
                const interest_level = document.getElementById('guestInterest').value;

                if (!name || !profession || !referrer) {
                    alert('姓名、專業別和介紹人為必填項目。');
                    return;
                }
                
                let creatorToken = sessionStorage.getItem('guestCreatorToken');
                if (!creatorToken) {
                    creatorToken = Date.now().toString(36) + Math.random().toString(36).substring(2);
                    sessionStorage.setItem('guestCreatorToken', creatorToken);
                }

                const { error } = await supabaseClient.from('guests').insert({ name, profession, referrer, interest_level, creator_token: creatorToken });
                
                if (error) {
                    alert('登記失敗：' + error.message);
                } else {
                    alert('感謝您的登記！');
                    document.getElementById('guestName').value = '';
                    document.getElementById('guestProfession').value = '';
                    document.getElementById('guestReferrer').value = '';
                    showPublicGuestList();
                }
            }
            
            async function deleteGuest(guestId, guestName) {
                // 安全性檢查：從資料庫再次確認 token
                const creatorToken = sessionStorage.getItem('guestCreatorToken');
                if (!creatorToken) return alert('無法驗證您的身分，無法刪除。');

                const { data: guest, error: fetchError } = await supabaseClient.from('guests').select('creator_token').eq('id', guestId).single();

                if (fetchError || !guest || guest.creator_token !== creatorToken) {
                    return alert('權限不足，您只能刪除自己新增的來賓資料。');
                }

                if (confirm(`確定要刪除來賓 ${guestName} 的資料嗎？`)) {
                     const { error } = await supabaseClient.from('guests').delete().eq('id', guestId);
                    if (error) {
                        alert('刪除失敗：' + error.message);
                    } else {
                        alert('刪除成功！');
                        showPublicGuestList();
                        if (!document.getElementById('adminPanelScreen').classList.contains('hidden')) {
                            showGuestList();
                        }
                    }
                }
            }
            window.deleteGuest = deleteGuest;

            // ... (promoteGuestToMember 函式不變) ...
            // ★★★ (修改) 來賓名單功能 JS END ★★★

            
            document.addEventListener('DOMContentLoaded', function() {
                // ... (省略大部分未修改的事件監聽) ...

                // ★★★ (修改) 來賓名單功能 事件監聽 START ★★★
                document.getElementById('toggleGuestFormBtn')?.addEventListener('click', () => {
                    document.getElementById('guestFormContainer').classList.toggle('hidden');
                });
                document.getElementById('submitGuestBtn')?.addEventListener('click', addGuest);
                document.getElementById('showGuestListBtn')?.addEventListener('click', showGuestList);
                // ★★★ (修改) 來賓名單功能 事件監聽 END ★★★

                // ... (省略其他事件監聽) ...
                
                checkSession();
                showLoginRanking();
                showPublicGuestList(); // 頁面載入時就顯示公開來賓列表
            });

        })();
    </script>
</body>
</html>

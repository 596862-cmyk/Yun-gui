<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNI雲貴分會 - 新手村任務系統 (偵錯版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS 樣式維持不變 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .task-card { transition: all 0.3s ease; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .completed { background: linear-gradient(135deg, #10b981, #059669); }
        .in-progress { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .not-started { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-circle { transition: stroke-dashoffset 0.35s; }
        .category-filter { transition: all 0.3s ease; }
        .category-filter.active { background: linear-gradient(135deg, #8b5cf6, #7c3aed); transform: scale(1.05); }
        .spinner { border-color: transparent; border-top-color: white; }
        [hidden] { display: none !important; }
        #debug-textarea { background-color: rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; font-family: monospace; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 min-h-screen">
    
    <div id="loginContainer" class="container mx-auto px-4 py-8 flex flex-col items-center justify-center min-h-screen">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 w-full max-w-md text-center mb-8"><h1 class="text-3xl font-bold text-white mb-2">BNI 新手村任務系統</h1><p class="text-blue-200 mb-6">請輸入您的姓名登入 (導師請加填密碼)</p><input type="text" id="nameInput" placeholder="請輸入姓名" class="w-full bg-white/10 text-white placeholder-blue-300 rounded-lg px-4 py-3 border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all mb-4 text-lg"><input type="password" id="passwordInput" placeholder="導師請輸入密碼 (導生免填)" class="w-full bg-white/10 text-white placeholder-blue-300 rounded-lg px-4 py-3 border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all mb-4 text-lg"><button id="loginBtn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all text-lg">登入</button><p id="loginMessage" class="text-red-400 mt-4 h-4"></p></div>
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 w-full max-w-md"><h3 class="text-xl font-semibold text-white mb-4 text-center">🏆 導生進度排行榜</h3><div id="leaderboardContainer" class="space-y-3"><p id="leaderboardLoading" class="text-blue-200 text-center">排行榜載入中...</p></div></div>
    </div>
    <div id="mentorContainer" class="container mx-auto px-4 py-8" hidden><div class="flex justify-between items-center mb-6"><p id="mentorWelcomeMessage" class="text-white text-lg"></p><button id="mentorLogoutBtn" class="bg-red-600/50 hover:bg-red-600/80 text-white rounded-lg px-4 py-2 border border-red-400/50 transition-all">登出</button></div><div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-8 border border-white/20"><h2 class="text-2xl font-semibold text-white mb-4">導師管理後台</h2><div class="mb-6"><h3 class="text-lg font-semibold text-white mb-2">新增導生</h3><div class="flex gap-4"><input type="text" id="newMenteeNameInput" placeholder="請輸入新導生姓名" class="flex-grow bg-white/10 text-white placeholder-blue-300 rounded-lg px-4 py-2 border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all"><button id="addMenteeBtn" class="bg-green-600 hover:bg-green-700 text-white rounded-lg px-5 py-2 font-semibold transition-all">新增</button></div><p id="mentorActionMessage" class="text-green-300 mt-2 h-4"></p></div><div><h3 class="text-lg font-semibold text-white mb-2">導生列表 (點擊可查看/修改進度)</h3><div id="menteeListContainer" class="space-y-2"></div></div></div></div>
    <div id="taskAppContainer" class="container mx-auto px-4 py-8" hidden><div class="flex justify-between items-center mb-6"><p id="taskAppWelcomeMessage" class="text-white text-lg"></p><div><button id="backToMentorBtn" class="bg-gray-600 hover:bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-400/50 transition-all mr-2" hidden>返回後台</button><button id="taskAppLogoutBtn" class="bg-red-600/50 hover:bg-red-600/80 text-white rounded-lg px-4 py-2 border border-red-400/50 transition-all">登出</button></div></div><div class="text-center mb-8"><h1 class="text-4xl md:text-5xl font-bold text-white mb-2">🏢 BNI雲貴分會</h1><h2 class="text-2xl md:text-3xl font-semibold text-blue-200 mb-4">新手村任務系統</h2></div><div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-8 border border-white/20"><div class="flex flex-col md:flex-row items-center justify-between mb-6"><h2 id="progressTitle" class="text-xl md:text-2xl font-semibold text-white mb-4 md:mb-0">總體進度</h2><div id="saveStatus" class="text-sm text-blue-200 h-4 flex items-center"></div><div class="flex items-center space-x-6"><div class="text-center"><div class="text-2xl md:text-3xl font-bold text-white" id="completedTasksTotal">0</div><div class="text-sm text-blue-200">已完成</div></div><div class="relative w-16 h-16 md:w-20 md:h-20"><svg class="progress-ring w-full h-full" viewBox="0 0 120 120"><circle class="progress-ring-circle stroke-white/20" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/><circle class="progress-ring-circle stroke-green-400" stroke-width="8" fill="transparent" r="52" cx="60" cy="60" stroke-dasharray="326.73" stroke-dashoffset="326.73" id="progressCircle"/></svg><div class="absolute inset-0 flex items-center justify-center"><span class="text-white font-bold text-sm" id="progressPercent">0%</span></div></div></div></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div class="bg-green-500/20 rounded-lg p-3 text-center"><div class="text-xl font-bold text-green-300" id="completedTasks">0</div><div class="text-green-200 text-sm">已完成</div></div><div class="bg-yellow-500/20 rounded-lg p-3 text-center"><div class="text-xl font-bold text-yellow-300" id="inProgressTasks">0</div><div class="text-yellow-200 text-sm">進行中</div></div><div class="bg-blue-500/20 rounded-lg p-3 text-center"><div class="text-xl font-bold text-blue-300" id="notStartedTasks">0</div><div class="text-blue-200 text-sm">未開始</div></div><div class="bg-purple-500/20 rounded-lg p-3 text-center"><div class="text-xl font-bold text-purple-300" id="totalTasks">0</div><div class="text-purple-200 text-sm">必修關卡</div></div></div></div><div class="mb-8"><h3 class="text-lg font-semibold text-white mb-4">任務分類</h3><div class="flex flex-wrap gap-2" id="categoryFilters"><button class="category-filter active bg-white/10 backdrop-blur-lg px-4 py-2 rounded-full text-white text-sm font-medium border border-white/20" data-category="all">全部</button></div></div><div class="flex flex-col md:flex-row gap-4 mb-8"><div class="flex-grow"><input type="text" id="searchInput" placeholder="🔍 搜尋任務名稱或描述..." class="w-full bg-white/10 text-white placeholder-blue-300 rounded-lg px-4 py-2 border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all"></div><div class="flex-shrink-0"><select id="sortSelect" class="w-full md:w-auto bg-white/10 text-white rounded-lg px-4 py-2 border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all"><option value="default" class="bg-indigo-800">預設排序</option><option value="status" class="bg-indigo-800">依狀態 (未開始優先)</option><option value="difficulty" class="bg-indigo-800">依難度 (基礎優先)</option></select></div><div class="flex-shrink-0"><button id="resetAllBtn" class="w-full md:w-auto bg-red-600/50 hover:bg-red-600/80 text-white rounded-lg px-4 py-2 border border-red-400/50 transition-all">🗑️ 全部重置</button></div></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="taskContainer"></div>
    
    <div id="modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-11/12 text-center transform scale-95 transition-transform">
            <div id="modal-icon" class="text-6xl mb-4">🎉</div>
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-2">恭喜完成任務！</h3>
            <div id="modal-content" class="text-gray-600 mb-6"></div>
            <button id="modal-close-btn" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all">繼續加油！</button>
        </div>
    </div>


    <script>
        (function() {
            const API_URL = 'https://script.google.com/macros/s/AKfycbyfCTkub5yQPonaEILuthwg_C_U37Rc3FDoANwwY9p__GDKrxTAS4VXNL6iD-q_MiwU_g/exec';
            const tasksTemplate = [
                {id:1,title:"新手包",description:"收到區域寄送的會員新手包",icon:"📦",difficulty:"基礎",reward:"新手資料包",category:"入門準備",isRequired:!0},{id:2,title:"名牌",description:"製作個人專屬的BNI名牌",icon:"🏷️",difficulty:"基礎",reward:"個人名牌",category:"入門準備",isRequired:!0},{id:3,title:"參加25s專業簡報培訓",description:"觀看25秒專業簡報教學影片",icon:"🎤",difficulty:"基礎",reward:"簡報技能",category:"影片培訓",videoUrl:"https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf",isRequired:!0},{id:4,title:"【導師考核】每周25s專業簡報",description:"通過導師考核，展示25秒專業簡報能力",icon:"✅",difficulty:"考核",reward:"簡報認證",category:"導師考核",isRequired:!0},{id:5,title:"【導師考核】25秒自我介紹及Slogan",description:"完成25秒自我介紹和個人Slogan展示",icon:"🗣️",difficulty:"考核",reward:"自我介紹認證",category:"導師考核",isRequired:!0},{id:6,title:"參加Connect系統開通&操作培訓",description:"觀看Connect系統教學影片(共2部)",icon:"💻",difficulty:"基礎",reward:"系統操作技能",category:"影片培訓",videoUrl:"https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf",isRequired:!0},{id:7,title:"【導師考核】Connect系統開通&操作",description:"通過Connect系統開通&操作考核",icon:"🔗",difficulty:"考核",reward:"系統操作認證",category:"導師考核",isRequired:!0},{id:8,title:"參加目標設定培訓",description:"觀看目標設定教學影片",icon:"🎯",difficulty:"基礎",reward:"目標規劃技能",category:"影片培訓",videoUrl:"https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf",isRequired:!0},{id:9,title:"【導師考核】目標設定",description:"完成個人目標設定並通過導師考核",icon:"📊",difficulty:"考核",reward:"目標設定認證",category:"導師考核",isRequired:!0},{id:10,title:"參加人脈合作變現表培訓",description:"觀看人脈合作變現表教學影片",icon:"💰",difficulty:"進階",reward:"變現技能",category:"影片培訓",videoUrl:"https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf",isRequired:!0},{id:11,title:"【導師考核】人脈合作變現表",description:"完成人脈合作變現表並通過考核",icon:"💎",difficulty:"考核",reward:"變現表認證",category:"導師考核",isRequired:!0},{id:12,title:"新會員見面會",description:"參與每月一次由區域排定時間的新人見面會",icon:"🤝",difficulty:"基礎",reward:"人脈建立",category:"實體活動",completionCondition:"參與每月一次由區域排定時間的新人見面會(一個月只有一次很重要)",isRequired:!0},{id:13,title:"FB區域粉專按讚",description:"雲貴分會FB點讚",icon:"👍",difficulty:"基礎",reward:"社群連結",category:"社交活動",fbUrl:"https://www.facebook.com/bni.yungui",isRequired:!0},{id:14,title:"初階MSP",description:"報名區域培訓課程(與進階MSP擇一即可)",icon:"📈",difficulty:"進階",reward:"初階MSP證書",category:"線上課程",courseUrl:"https://ally.nime.com.tw/html/memberLogin",isRequired:!0},{id:15,title:"進階MSP",description:"報名區域培訓課程(與初階MSP擇一即可)",icon:"🚀",difficulty:"進階",reward:"進階MSP證書",category:"線上課程",courseUrl:"https://ally.nime.com.tw/html/memberLogin",isRequired:!0},{id:16,title:"會員成功藍圖",description:"參與導師八周特定主題",icon:"🗺️",difficulty:"進階",reward:"成功藍圖",category:"導師八周",isRequired:!0},{id:17,title:"新會員護照",description:"參與導師八周特定主題",icon:"📘",difficulty:"進階",reward:"會員護照",category:"導師八周",isRequired:!0},{id:18,title:"導師八周",description:"參與4次每周四導師八周",icon:"🧙‍♂️",difficulty:"進階",reward:"導師指導完成證書",category:"導師八周",weeklyTopics:["W1: 會員成功藍圖/出席的重要性","W2: 行政小組運作/明確目標","W3: 新會員護照/告訴我們怎麼說","W4: 邀約來賓心法與技巧/帶來小道具","W5: 會員成功藍圖/非同凡響的見證","W6: 行政小組運作/一對一會面","W7: 新會員護照/為什麼要帶來賓","W8: 邀約來賓心法與技巧/我們應該怎麼做"],isRequired:!0,isCountable:!0,targetCount:4},{id:19,title:"全國分享會",description:"參與每周一全國分享會1次",icon:"🌟",difficulty:"進階",reward:"全國視野",category:"大型活動",isRequired:!0},{id:20,title:"參加紅綠燈計算培訓",description:"觀看紅綠燈計算教學影片",icon:"🚦",difficulty:"進階",reward:"分析技能",category:"影片培訓",videoUrl:"https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf",isRequired:!0},{id:21,title:"【導師考核】紅綠燈計算",description:"通過紅綠燈計算方法考核",icon:"📊",difficulty:"考核",reward:"分析認證",category:"導師考核",isRequired:!0},{id:22,title:"導師示範一對一",description:"邀約導師由導師示範一對一",icon:"👁️",difficulty:"進階",reward:"實戰經驗",category:"實戰學習",isRequired:!0},{id:23,title:"参加1-1表格 1、2表培訓",description:"觀看1-1表格教學影片",icon:"📋",difficulty:"進階",reward:"表格技能",category:"影片培訓",videoUrl:"https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf",isRequired:!0},{id:24,title:"【導師考核】完成1-1表格 1、2表",description:"完成1-1表格1、2表並通過考核",icon:"✍️",difficulty:"考核",reward:"表格認證",category:"導師考核",isRequired:!0},{id:25,title:"参加1-1表格 3、4表培訓",description:"觀看1-1表格教學影片",icon:"📄",difficulty:"進階",reward:"進階表格技能",category:"影片培訓",videoUrl:"https://www.youtube.com/playlist?list=PLTMduYKemBTo1Vcmefgg7QhBL8oT4Ypkf",isRequired:!0},{id:26,title:"【導師考核】完成1-1表格 3、4表",description:"完成1-1表格3、4表並通過考核",icon:"📝",difficulty:"考核",reward:"進階表格認證",category:"導師考核",isRequired:!0},{id:27,title:"簡報工作坊(選修)",description:"報名區域培訓課程",icon:"🎪",difficulty:"選修",reward:"簡報專精技能",category:"選修課程",courseUrl:"https://ally.nime.com.tw/html/memberLogin",isRequired:!1},{id:28,title:"一對一工作坊(選修)",description:"報名區域培訓課程",icon:"👥",difficulty:"選修",reward:"面談技能",category:"選修課程",courseUrl:"https://ally.nime.com.tw/html/memberLogin",isRequired:!1},{id:29,title:"與導師一對一(選修)",description:"邀約導師進行一對一面談",icon:"🎯",difficulty:"選修",reward:"導師指導",category:"選修課程",isRequired:!1},{id:30,title:"與董顧大使一對一(選修)",description:"邀約董事顧問大使進行一對一面談",icon:"👔",difficulty:"選修",reward:"高階指導",category:"選修課程",isRequired:!1},{id:31,title:"與九長一對一(選修)",description:"邀約九長進行一對一面談交流",icon:"🏆",difficulty:"選修",reward:"領導指導",category:"選修課程",isRequired:!1}
            ];
            
            let currentUser = null, currentlyViewingName = '', tasks = [], currentFilter = 'all', currentSort = 'default', currentSearch = '', saveTimeout;
            
            // --- 偵錯版 Modal 函式 ---
            function showModal({icon, title, content, buttonText}) {
                const modal = document.getElementById('modal');
                document.getElementById('modal-icon').textContent = icon;
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-content').innerHTML = ''; // 清空舊內容
                
                // 如果 content 是字串，就直接顯示
                if (typeof content === 'string') {
                    const p = document.createElement('p');
                    p.textContent = content;
                    document.getElementById('modal-content').appendChild(p);
                } else { // 否則假定是 HTML 元素
                    document.getElementById('modal-content').appendChild(content);
                }

                document.getElementById('modal-close-btn').textContent = buttonText;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            function closeModel() {
                document.getElementById('modal').classList.add('hidden');
                document.getElementById('modal').classList.remove('flex');
            }

            function showCelebration(taskTitle, customMessage = null) {
                const message = customMessage || `已完成任務：${taskTitle}。繼續保持！`;
                const title = customMessage ? '🎉 恭喜！ 🎉' : '恭喜完成任務！';
                showModal({ icon: '🎉', title: title, content: message, buttonText: '繼續加油！' });
            }
            
            // *** 偵錯核心：新的 apiCall 函式 ***
            async function apiCall(action, payload) {
                const messageEl = (action === 'login' || action === 'getLeaderboardData') ? document.getElementById('loginMessage') : document.getElementById('mentorActionMessage');
                if (messageEl) messageEl.textContent = '處理中...';
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST', redirect: 'follow', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action, payload })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`網路錯誤，狀態碼: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.status === 'success') {
                        if (messageEl) messageEl.textContent = '';
                        return result.data;
                    }
                    // 如果後端回報錯誤，也把它丟出來
                    throw new Error(result.message || '後端回報未知錯誤');
                } catch (error) {
                    const errorMsgForUser = `操作失敗，請將以下所有偵錯文字完整複製回報`;
                    if (messageEl) messageEl.textContent = '操作失敗，請查看彈出視窗';

                    const debugContent = document.createElement('textarea');
                    debugContent.id = 'debug-textarea';
                    debugContent.rows = 8;
                    debugContent.className = 'w-full p-2 text-xs rounded-md';
                    debugContent.value = `[錯誤摘要]\n${error.message}\n\n[偵錯資訊]\nAction: ${action}\nPayload: ${JSON.stringify(payload, null, 2)}\nError Name: ${error.name}\nError Stack: ${error.stack || 'N/A'}`;
                    debugContent.readOnly = true;

                    // 使用新的 Modal 顯示詳細錯誤
                    showModal({
                        icon: '⚠️',
                        title: '發生錯誤',
                        content: debugContent,
                        buttonText: '關閉'
                    });

                    // 向上拋出錯誤，讓呼叫它的函式知道已經出錯
                    throw error;
                }
            }

            // --- 以下為既有函式，邏輯無變動 ---
            async function loadLeaderboard() { try { const leaderboardData = await apiCall('getLeaderboardData', {}); renderLeaderboard(leaderboardData); } catch (e) { console.error("Failed to load leaderboard:", e); } }
            function renderLeaderboard(data) { const container = document.getElementById('leaderboardContainer'); const loadingEl = document.getElementById('leaderboardLoading'); loadingEl.hidden = true; container.innerHTML = ''; if (!data || data.length === 0) { container.innerHTML = `<p class="text-blue-200 text-center">目前沒有導生資料</p>`; return; } data.forEach((mentee, index) => { const rankColor = index === 0 ? 'text-yellow-300' : index === 1 ? 'text-gray-300' : index === 2 ? 'text-yellow-600' : 'text-blue-300'; const progress = Math.round(mentee.progress); const div = document.createElement('div'); div.className = 'flex items-center gap-4 text-white'; div.innerHTML = `<span class="w-8 text-lg font-bold ${rankColor}">#${index + 1}</span><div class="flex-grow"><p class="font-semibold">${mentee.name}</p><div class="w-full bg-black/20 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width: ${progress}%"></div></div></div><span class="w-12 text-right font-semibold">${progress}%</span>`; container.appendChild(div); }); }
            async function handleLogin() { const name = document.getElementById('nameInput').value.trim(); const password = document.getElementById('passwordInput').value; if (!name) return; try { currentUser = await apiCall('login', { name, password }); sessionStorage.setItem('bniUser', JSON.stringify(currentUser)); switchView(); } catch (e) { /* error is now handled by the modal */ } }
            function handleLogout() { currentUser = null; currentlyViewingName = ''; sessionStorage.removeItem('bniUser'); switchView(); }
            function switchView() { document.getElementById('loginContainer').hidden = true; document.getElementById('mentorContainer').hidden = true; document.getElementById('taskAppContainer').hidden = true; if (!currentUser) { document.getElementById('loginContainer').hidden = false; document.getElementById('nameInput').value = ''; document.getElementById('passwordInput').value = ''; loadLeaderboard(); } else if (currentUser.role === 'mentor' && !currentlyViewingName) { document.getElementById('mentorContainer').hidden = false; loadMentorDashboard(); } else { document.getElementById('taskAppContainer').hidden = false; loadTaskApp(); } }
            async function loadMentorDashboard() { document.getElementById('mentorWelcomeMessage').textContent = `歡迎, 導師 ${currentUser.name}`; try { const mentees = await apiCall('getMenteesList', { mentorName: currentUser.name }); renderMenteeList(mentees); } catch (e) {} }
            function renderMenteeList(mentees) { const container = document.getElementById('menteeListContainer'); container.innerHTML = mentees.length === 0 ? `<p class="text-blue-300">目前沒有導生</p>` : ''; mentees.forEach(name => { const div = document.createElement('div'); div.className = 'bg-white/5 rounded-lg p-3 flex justify-between items-center'; div.innerHTML = `<span class="text-white font-semibold cursor-pointer hover:text-blue-300">${name}</span><button data-name="${name}" class="delete-mentee-btn bg-red-800 hover:bg-red-700 text-white rounded px-3 py-1 text-xs">刪除</button>`; div.querySelector('span').addEventListener('click', () => viewMenteeTasks(name)); container.appendChild(div); }); }
            async function handleAddMentee() { const input = document.getElementById('newMenteeNameInput'); const menteeName = input.value.trim(); if (!menteeName) return; const msgEl = document.getElementById('mentorActionMessage'); try { await apiCall('addNewMentee', { menteeName, mentorName: currentUser.name }); msgEl.className = 'text-green-300 mt-2 h-4'; msgEl.textContent = `成功新增導生 ${menteeName}`; input.value = ''; loadMentorDashboard(); } catch (e) { msgEl.className = 'text-red-400 mt-2 h-4'; } }
            async function handleDeleteMentee(e) { if (!e.target.classList.contains('delete-mentee-btn')) return; const menteeName = e.target.dataset.name; if (confirm(`您確定要刪除導生 "${menteeName}" 的所有資料嗎？此操作無法復原！`)) { const msgEl = document.getElementById('mentorActionMessage'); try { await apiCall('deleteMentee', { menteeName, mentorName: currentUser.name }); msgEl.className = 'text-green-300 mt-2 h-4'; msgEl.textContent = `成功刪除導生 ${menteeName}`; loadMentorDashboard(); } catch (e) { msgEl.className = 'text-red-400 mt-2 h-4'; } } }
            function viewMenteeTasks(name) { currentlyViewingName = name; switchView(); }
            function backToMentorDashboard() { currentlyViewingName = ''; switchView(); }
            async function loadTaskApp() { const nameToLoad = currentlyViewingName || currentUser.name; document.getElementById('backToMentorBtn').hidden = !(currentUser.role === 'mentor'); document.getElementById('taskAppWelcomeMessage').textContent = `歡迎, ${currentUser.name}`; document.getElementById('progressTitle').textContent = `${nameToLoad} 的任務進度`; try { const savedTasks = await apiCall('getTasks', { name: nameToLoad }); initializeUserData(savedTasks); runTaskAppDisplay(); } catch(e) {} }
            function runTaskAppDisplay() { generateCategoryFilters(); filterTasks('all'); updateProgress(); }
            function initializeUserData(savedTasks) { tasks = tasksTemplate.map(template => ({...template, status: 'not-started', currentCount: 0 })); tasks.forEach(task => { const saved = savedTasks.find(s => s.id == task.id); if (saved) { task.status = saved.status; task.currentCount = saved.currentCount || 0; } }); }
            function saveTasks() { const nameToSave = currentlyViewingName || currentUser.name; const saveStatus = document.getElementById('saveStatus'); saveStatus.innerHTML = `<div class="spinner w-4 h-4 rounded-full animate-spin border-2 border-solid mr-2"></div> 儲存中...`; clearTimeout(saveTimeout); saveTimeout = setTimeout(async () => { const dataToSave = tasks.map(t => ({ id: t.id, status: t.status, currentCount: t.currentCount || 0 })); try { await apiCall('saveTasks', { name: nameToSave, tasks: dataToSave, requesterName: currentUser.name, requesterRole: currentUser.role }); saveStatus.textContent = `✅ 進度已同步至雲端`; } catch (e) { saveStatus.textContent = `❌ 儲存失敗`; } }, 1500); }
            function updateTaskStatus(taskId, newStatus) { const task = tasks.find(t => t.id == taskId); if (task) { const oldStatus = task.status; task.status = newStatus; if (tasksTemplate.find(t=>t.id==taskId)?.isCountable && newStatus === 'not-started') task.currentCount = 0; if (oldStatus !== 'completed' && newStatus === 'completed') showCelebration(tasksTemplate.find(t=>t.id==taskId)?.title); renderTasks(); updateProgress(); saveTasks(); } }
            function incrementCount(taskId) { const task = tasks.find(t => t.id == taskId); const taskTemplate = tasksTemplate.find(t => t.id == taskId); if (task && taskTemplate?.isCountable && task.currentCount < taskTemplate.targetCount) { task.currentCount++; task.status = task.currentCount === taskTemplate.targetCount ? 'completed' : 'in-progress'; if (task.status === 'completed') showCelebration(taskTemplate.title); renderTasks(); updateProgress(); saveTasks(); } }
            function decrementCount(taskId) { const task = tasks.find(t => t.id == taskId); if (task && tasksTemplate.find(t=>t.id==taskId)?.isCountable && task.currentCount > 0) { task.currentCount--; task.status = task.currentCount === 0 ? 'not-started' : 'in-progress'; renderTasks(); updateProgress(); saveTasks(); } }
            function resetAllTasks() { if (confirm(`您確定要重置 ${currentlyViewingName || currentUser.name} 的所有任務進度嗎？`)) { initializeUserData([]); renderTasks(); updateProgress(); saveTasks(); alert('所有任務進度已重置！'); } }
            function generateCategoryFilters() { const c = document.getElementById('categoryFilters'); if (c.children.length > 1) return; const a=[...new Set(tasksTemplate.map(t=>t.category))], b=c.querySelector('[data-category="all"]'), d=tasksTemplate.filter(t=>t.isRequired).length, e=tasksTemplate.filter(t=>!t.isRequired).length; b.textContent=`全部 (${d}必修+${e}選修)`; a.forEach(f=>{const g=tasksTemplate.filter(t=>t.category===f).length,h=document.createElement('button'); h.className='category-filter bg-white/10 backdrop-blur-lg px-4 py-2 rounded-full text-white text-sm font-medium border border-white/20'; h.setAttribute('data-category',f); h.textContent=`${f} (${g})`; c.appendChild(h)}); c.querySelectorAll('.category-filter').forEach(btn => btn.addEventListener('click', () => filterTasks(btn.dataset.category))) }
            function filterTasks(category) { currentFilter = category; document.querySelectorAll('.category-filter').forEach(btn => btn.classList.remove('active')); document.querySelector(`[data-category="${category}"]`).classList.add('active'); renderTasks(); }
            function renderTasks() { const container = document.getElementById('taskContainer'); container.innerHTML = ''; let processedTasks = [...tasks]; const taskTemplatesById = Object.fromEntries(tasksTemplate.map(t => [t.id, t])); processedTasks.forEach(task => task.category = taskTemplatesById[task.id]?.category); if (currentFilter !== 'all') { processedTasks = processedTasks.filter(task => task.category === currentFilter); } if (currentSearch) { const searchTerm = currentSearch.toLowerCase(); processedTasks = processedTasks.filter(task => taskTemplatesById[task.id]?.title.toLowerCase().includes(searchTerm) || taskTemplatesById[task.id]?.description.toLowerCase().includes(searchTerm)); } const difficultyOrder = { '基礎': 1, '進階': 2, '考核': 3, '選修': 4 }; const statusOrder = { 'not-started': 1, 'in-progress': 2, 'completed': 3 }; processedTasks.sort((a, b) => { const diffA = difficultyOrder[taskTemplatesById[a.id]?.difficulty] || 99; const diffB = difficultyOrder[taskTemplatesById[b.id]?.difficulty] || 99; if (currentSort === 'status') { return statusOrder[a.status] - statusOrder[b.status] || a.id - b.id; } if (currentSort === 'difficulty') { return diffA - diffB || a.id - b.id; } return a.id - b.id; }); processedTasks.forEach(task => { const taskTemplate = taskTemplatesById[task.id] || {}; const isAssessment = taskTemplate.difficulty === '考核'; const menteeCannotOperate = currentUser.role === 'mentee' && !currentlyViewingName; const disabledState = isAssessment && menteeCannotOperate; const disabledTitle = '此項目需由導師操作'; const statusClass = task.status; const statusText = task.status === 'completed' ? '已完成' : task.status === 'in-progress' ? '進行中' : '未開始'; const statusIcon = task.status === 'completed' ? '✅' : task.status === 'in-progress' ? '⏳' : '⭕'; const difficultyColor = taskTemplate.difficulty === '基礎' ? 'text-green-400' : taskTemplate.difficulty === '進階' ? 'text-yellow-400' : taskTemplate.difficulty === '考核' ? 'text-red-400' : taskTemplate.difficulty === '選修' ? 'text-purple-400' : 'text-orange-400'; const countDisplay = taskTemplate.isCountable ? `<div class="bg-blue-500/20 rounded-lg p-2 mb-3"><div class="flex items-center justify-between"><span class="text-sm text-blue-300">進度</span><span class="text-base font-bold text-blue-200">${task.currentCount}/${taskTemplate.targetCount}</span></div><div class="w-full bg-white/10 rounded-full h-2 mt-1"><div class="bg-blue-400 h-2 rounded-full transition-all" style="width: ${taskTemplate.targetCount > 0 ? (task.currentCount / taskTemplate.targetCount) * 100 : 0}%"></div></div></div>` : ''; const startCompleteButton = task.status !== 'completed' ? `<button data-task-id="${task.id}" data-status="${task.status === 'not-started' ? 'in-progress' : 'completed'}" class="flex-1 py-2 px-3 rounded-lg font-medium text-base transition-all status-change-btn ${disabledState ? 'bg-gray-600 text-gray-400 cursor-not-allowed' : (task.status === 'not-started' ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white')}" ${disabledState ? `disabled title="${disabledTitle}"` : ''}>${task.status === 'not-started' ? '開始' : '完成'}</button>` : ''; const resetButton = task.status !== 'not-started' ? `<button data-task-id="${task.id}" data-status="not-started" class="py-2 px-3 bg-gray-600 text-white rounded-lg font-medium text-base transition-all status-change-btn ${disabledState ? 'hover:bg-gray-600 text-gray-400 cursor-not-allowed' : 'hover:bg-gray-700'}" ${disabledState ? `disabled title="${disabledTitle}"` : ''}>重置</button>` : ''; const counterButtons = taskTemplate.isCountable ? `${task.currentCount < taskTemplate.targetCount ? `<button data-task-id="${task.id}" class="flex-1 py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-base transition-all increment-btn">+1 次參與</button>` : ''}${task.currentCount > 0 ? `<button data-task-id="${task.id}" class="py-2 px-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium text-base transition-all decrement-btn">-1</button>` : ''}` : `${startCompleteButton}${resetButton}`; const card = document.createElement('div'); card.className = `task-card bg-white/10 backdrop-blur-lg rounded-2xl p-5 border border-white/20 flex flex-col ${statusClass}`; card.innerHTML = `<div class="flex-grow"><div class="flex items-start justify-between mb-3"><div class="text-3xl">${taskTemplate.icon}</div><div class="flex items-center space-x-2"><span class="text-sm">${statusIcon}</span><span class="text-base">${statusText}</span></div></div><h3 class="text-lg font-semibold text-white mb-2 leading-tight">${taskTemplate.title}</h3><p class="text-blue-200 mb-3 text-sm leading-relaxed">${taskTemplate.description || ''}</p>${countDisplay}<div class="flex items-center justify-between mb-3"><span class="text-sm ${difficultyColor} font-medium px-2 py-1 bg-white/10 rounded">${taskTemplate.difficulty}</span><span class="text-sm text-purple-300">🎁 ${taskTemplate.reward}</span></div><div class="text-sm text-blue-300 mb-3">${taskTemplate.category}</div><div class="bg-white/5 rounded-lg p-3 mb-3"><div class="text-base text-gray-300 mb-1">完成條件：</div><div class="text-base text-white">${taskTemplate.completionCondition || taskTemplate.description}</div>${taskTemplate.videoUrl ? `<div class="mt-2"><button class="inline-flex items-center text-base text-blue-300 hover:text-blue-200 transition-colors cursor-pointer external-link" data-url="${taskTemplate.videoUrl}">📹 觀看教學影片</button></div>` : ''}${taskTemplate.fbUrl ? `<div class="mt-2"><button class="inline-flex items-center text-base text-blue-300 hover:text-blue-200 transition-colors cursor-pointer external-link" data-url="${taskTemplate.fbUrl}">👍 前往FB粉專</button></div>` : ''}${taskTemplate.courseUrl ? `<div class="mt-2"><button class="inline-flex items-center text-base text-blue-300 hover:text-blue-200 transition-colors cursor-pointer external-link" data-url="${taskTemplate.courseUrl}">📚 前往課程報名</button></div>` : ''}</div></div><div class="mt-auto flex space-x-2">${counterButtons}</div>`; container.appendChild(card); }); bindCardEventListeners(); }
            function updateProgress() { const requiredTasks = tasks.filter(t => tasksTemplate.find(tt => tt.id == t.id)?.isRequired); let completedCount = 0; const mspGroupCompleted = requiredTasks.some(t => (t.id == 14 || t.id == 15) && t.status === 'completed'); requiredTasks.forEach(task => { if (!(task.id == 14 || task.id == 15) && task.status === 'completed') { completedCount++; } }); if (mspGroupCompleted) completedCount++; const nonMspTasksCount = tasksTemplate.filter(t => t.isRequired && t.id != 14 && t.id != 15).length; const totalRequired = nonMspTasksCount + 1; const inProgressCount = tasks.filter(t => t.status === 'in-progress' && tasksTemplate.find(tt => tt.id == t.id)?.isRequired).length; const notStartedCount = tasks.filter(t => t.status === 'not-started' && tasksTemplate.find(tt => tt.id == t.id)?.isRequired).length; const allCompletedCount = tasks.filter(t => t.status === 'completed' && tasksTemplate.find(tt => tt.id == t.id)?.isRequired).length; document.getElementById('completedTasks').textContent = allCompletedCount; document.getElementById('completedTasksTotal').textContent = allCompletedCount; document.getElementById('inProgressTasks').textContent = inProgressCount; document.getElementById('notStartedTasks').textContent = notStartedCount; document.getElementById('totalTasks').textContent = totalRequired; const progressPercent = totalRequired > 0 ? (completedCount / totalRequired) * 100 : 0; document.getElementById('progressPercent').textContent = `${Math.round(progressPercent)}%`; const progressCircle = document.getElementById('progressCircle'); const circumference = 2 * Math.PI * progressCircle.r.baseVal.value; progressCircle.style.strokeDashoffset = circumference - (progressPercent / 100) * circumference; const celebrationKey = 'celebrated' + (currentlyViewingName || currentUser.name); if (progressPercent >= 100 && !sessionStorage.getItem(celebrationKey)) { showCelebration("所有必修任務", `恭喜 ${currentlyViewingName || currentUser.name}！已完成所有必修關卡！`); sessionStorage.setItem(celebrationKey, 'true'); } }
            function bindCardEventListeners() { document.querySelectorAll('.increment-btn, .decrement-btn, .status-change-btn, .external-link').forEach(button => { const clone = button.cloneNode(true); button.parentNode.replaceChild(clone, button); }); document.querySelectorAll('.increment-btn').forEach(b => b.addEventListener('click', (e) => { e.stopPropagation(); incrementCount(e.target.dataset.taskId); })); document.querySelectorAll('.decrement-btn').forEach(b => b.addEventListener('click', (e) => { e.stopPropagation(); decrementCount(e.target.dataset.taskId); })); document.querySelectorAll('.status-change-btn').forEach(b => b.addEventListener('click', (e) => { e.stopPropagation(); updateTaskStatus(e.target.dataset.taskId, e.target.dataset.status); })); document.querySelectorAll('.external-link').forEach(b => b.addEventListener('click', (e) => { e.stopPropagation(); window.open(e.target.dataset.url, '_blank'); })); }
            
            function init() {
                document.getElementById('loginBtn').addEventListener('click', handleLogin);
                document.getElementById('nameInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
                document.getElementById('passwordInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
                document.getElementById('mentorLogoutBtn').addEventListener('click', handleLogout);
                document.getElementById('addMenteeBtn').addEventListener('click', handleAddMentee);
                document.getElementById('menteeListContainer').addEventListener('click', handleDeleteMentee);
                document.getElementById('taskAppLogoutBtn').addEventListener('click', handleLogout);
                document.getElementById('backToMentorBtn').addEventListener('click', backToMentorDashboard);
                document.getElementById('modal-close-btn').addEventListener('click', closeModel);
                document.getElementById('sortSelect').addEventListener('change', (e) => { currentSort = e.target.value; renderTasks(); });
                document.getElementById('searchInput').addEventListener('input', (e) => { currentSearch = e.target.value; renderTasks(); });
                document.getElementById('resetAllBtn').addEventListener('click', resetAllTasks);
                const storedUser = sessionStorage.getItem('bniUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                }
                switchView();
            }

            window.addEventListener('load', init);
        })();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNI雲貴分會 - 新手村任務系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        html { transition: font-size 0.2s ease-in-out; }
        body { font-family: 'Noto Sans TC', sans-serif; overflow-x: hidden; }
        .task-card { transition: all 0.3s ease; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .completed { background: linear-gradient(135deg, #10b981, #059669); }
        .in-progress { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .not-started { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-circle { transition: stroke-dashoffset 0.35s; }
        .category-filter { transition: all 0.3s ease; }
        .category-filter.active { background: linear-gradient(135deg, #8b5cf6, #7c3aed); transform: scale(1.05); }
        * { box-sizing: border-box; }
        .modal-overlay { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        .input-style {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            color: white;
        }
        .input-style::placeholder { color: #cbd5e1; }
        .input-style:focus { outline: none; ring: 2px; ring-color: #6366f1; }
        
        /* Calendar Styles */
        .calendar-table { border-collapse: separate; border-spacing: 2px; }
        .calendar-table th, .calendar-table td { width: 14.28%; }
        .calendar-day { min-height: 100px; }
        .calendar-day-today .day-number { background-color: #ec4899; color: white; }
        .event-item { background-color: rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 min-h-screen">
    <div id="fontSizeController" class="fixed bottom-4 right-4 z-50 flex items-center space-x-2 bg-white/10 backdrop-blur-lg p-2 rounded-full border border-white/20">
        <button id="decreaseFont" class="w-10 h-10 flex items-center justify-center bg-white/10 text-white rounded-full hover:bg-white/20 transition-colors text-lg font-bold">A-</button>
        <button id="resetFont" class="w-10 h-10 flex items-center justify-center bg-white/10 text-white rounded-full hover:bg-white/20 transition-colors text-sm font-bold">A</button>
        <button id="increaseFont" class="w-10 h-10 flex items-center justify-center bg-white/10 text-white rounded-full hover:bg-white/20 transition-colors text-xl font-bold">A+</button>
    </div>

    <div id="loginScreen" class="min-h-screen px-4 py-8">
        <div class="container mx-auto max-w-6xl">
            <div class="flex justify-center mb-8">
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full border border-white/20">
                    <div class="text-center mb-8">
                        <h1 class="text-4xl font-bold text-white mb-2">🏢 BNI雲貴分會</h1>
                        <h2 class="text-2xl font-semibold text-blue-200 mb-4">新手村任務系統</h2>
                        <p class="text-lg text-blue-300">請輸入您的導生資訊</p>
                        <p class="text-sm text-yellow-300 mt-2">⚠️ 導生帳號由導師建立，無法自行註冊</p>
                    </div>
                    <div id="loginFormContainer">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-white text-base font-medium mb-2">導生姓名</label>
                                <input type="text" id="memberName" required class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 text-base" placeholder="請輸入您的姓名">
                            </div>
                            <div>
                                <label class="block text-white text-base font-medium mb-2">導生密碼</label>
                                <input type="password" id="memberPassword" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 text-base" placeholder="請輸入導師為您設定的密碼">
                            </div>
                            <button type="button" id="loginButton" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all text-lg">
                                開始我的新手村之旅
                            </button>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <button type="button" id="showAdminBtn" class="text-blue-300 hover:text-blue-200 text-sm underline">
                            導師登入
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex justify-center mb-8">
                 <button type="button" id="toggleGuestSectionBtn" class="w-full max-w-md bg-teal-600/50 hover:bg-teal-500/50 text-white py-3 rounded-lg font-semibold transition-all text-lg">
                    📝 BNI 來賓登記
                </button>
            </div>

            <div id="guestFormSection" class="hidden">
                <div class="flex justify-center mb-8">
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full border border-white/20">
                        <h3 class="text-2xl font-semibold text-white mb-6 text-center">來賓登記表</h3>
                        <div class="space-y-4" id="guestForm">
                             <input type="text" id="guestName" required class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="來賓姓名">
                             <input type="text" id="guestProfession" required class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="來賓專業別">
                             <input type="text" id="guestReferrer" required class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="介紹人">
                             <select id="guestInterest" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                 <option value="高">加入意願度：高</option>
                                 <option value="中">加入意願度：中</option>
                                 <option value="低">加入意願度：低</option>
                             </select>
                             <button type="button" id="submitGuestBtn" class="w-full bg-gradient-to-r from-teal-500 to-cyan-500 text-white py-3 rounded-lg font-semibold hover:from-teal-600 hover:to-cyan-600 transition-all">
                                 提交登記
                             </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="calendarSection" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <h2 id="currentMonthYear" class="text-2xl font-bold text-white"></h2>
                    <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
                <table class="w-full calendar-table text-white">
                    <thead>
                        <tr class="text-blue-200 text-sm">
                            <th class="py-2">日</th>
                            <th class="py-2">一</th>
                            <th class="py-2">二</th>
                            <th class="py-2">三</th>
                            <th class="py-2">四</th>
                            <th class="py-2">五</th>
                            <th class="py-2">六</th>
                        </tr>
                    </thead>
                    <tbody id="calendarBody">
                        </tbody>
                </table>
            </div>

            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                <div id="togglePublicGuestList" class="flex items-center justify-center space-x-2 text-center mb-6 cursor-pointer">
                    <h2 class="text-2xl font-bold text-white">👋 最新來賓</h2>
                    <svg id="guestListChevron" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white transition-transform transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div id="publicGuestListContainer" class="space-y-3 transition-all duration-300">
                </div>
            </div>

            <div id="graduatedMembersSection" class="my-8 hidden">
                <div class="bg-gradient-to-r from-yellow-500/20 to-orange-500/20 backdrop-blur-lg rounded-2xl p-6 border border-yellow-400/30">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-yellow-300 mb-2">🏆 已出村導生表揚 🏆</h2>
                        <p class="text-yellow-200">恭喜以下導生完成所有必修任務，成為BNI專業導生！</p>
                    </div>
                    <div id="graduatedMembersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>
            <div id="loginRankingSection" class="mt-8 hidden">
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-white mb-2">📊 導生排行榜</h2>
                        <p class="text-blue-300">新手村任務完成進度排名</p>
                    </div>
                    <div id="loginRankingList" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="mainContent" class="container mx-auto px-4 py-8 hidden">... (omitted for brevity)</div>
    <div id="adminLoginScreen" class="min-h-screen items-center justify-center px-4 hidden">... (omitted for brevity)</div>
    <div id="adminPanelScreen" class="min-h-screen px-4 py-8 hidden">... (omitted for brevity)</div>
    <div id="memberTaskModal" class="fixed inset-0 bg-black/50 modal-overlay hidden items-center justify-center z-50">... (omitted for brevity)</div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        (function() {
            'use strict';
            
            const SUPABASE_URL = 'https://hdssnsnkagfjfbuvgfkn.supabase.co'; 
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhkc3Nuc25rYWdmamZidXZnZmtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MjAyMDksImV4cCI6MjA3MzE5NjIwOX0.UoSKuEbguyE-I2j8gRO_mclOffwkV6WFLwayjrkFsuY';
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            let currentMember = null;
            let tasks = []; 
            let tasksMasterList = [];
            let calendarNavDate = new Date();

            async function fetchTasksMaster() {
                const { data, error } = await supabaseClient
                    .from('tasks_master')
                    .select('*')
                    .order('id', { ascending: true });
                if (error) {
                    console.error('Error fetching tasks master list:', error);
                    alert('無法從資料庫載入任務列表，請檢查網路連線或聯繫管理員。');
                    return [];
                }
                return data;
            }

            function getInitialTasksForDB() {
                return tasksMasterList.map(task => ({
                    id: task.id,
                    status: 'not-started',
                    currentCount: task.isCountable ? 0 : undefined
                }));
            }
            
            function loadTasksFromMemberData(memberTasksProgress) {
                if (!Array.isArray(memberTasksProgress)) memberTasksProgress = [];
                tasks = tasksMasterList.map(templateTask => {
                    const progress = memberTasksProgress.find(p => p.id === templateTask.id);
                    return {
                        ...templateTask,
                        status: progress ? progress.status : 'not-started',
                        currentCount: progress ? progress.currentCount : (templateTask.isCountable ? 0 : undefined),
                    };
                });
            }

            async function handleLogin() {
                const nameInput = document.getElementById('memberName');
                const passwordInput = document.getElementById('memberPassword');
                const name = nameInput.value.trim();
                const password = passwordInput.value;
                if (!name) return alert('請填寫導生姓名');
                const { data, error } = await supabaseClient.from('members').select('*').eq('name', name).single();
                if (error || !data) return alert('❌ 導生不存在或查詢失敗！');
                if (data.password && data.password !== password) return alert('密碼錯誤！');
                currentMember = data;
                sessionStorage.setItem('currentMemberId', currentMember.id);
                loadTasksFromMemberData(currentMember.tasks);
                updateMemberDisplay(currentMember.name);
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                generateCategoryFilters();
                renderTasks();
                updateProgress();
            }

            async function createMember() {
                const nameInput = document.getElementById('newMemberName');
                const industryInput = document.getElementById('newMemberIndustry');
                const passwordInput = document.getElementById('newMemberPassword');
                const name = nameInput.value.trim();
                if (!name) return alert('請填寫導生姓名');
                const { data: existingMember } = await supabaseClient.from('members').select('id').eq('name', name).single();
                if (existingMember) return alert('導生姓名已存在，請使用不同的姓名');
                const { error } = await supabaseClient.from('members').insert({
                    name: name,
                    industry: industryInput.value.trim() || 'BNI導生',
                    password: passwordInput.value || null,
                    tasks: getInitialTasksForDB()
                });
                if (error) {
                    alert('建立導生失敗：' + error.message);
                } else {
                    const passwordInfo = passwordInput.value ? `密碼：${passwordInput.value}` : '無密碼';
                    alert(`✅ 導生建立成功！\n\n姓名：${name}\n${passwordInfo}`);
                    nameInput.value = '';
                    industryInput.value = '';
                    passwordInput.value = '';
                }
            }
            
            async function saveTasksToDB() {
                if (!currentMember) return;
                const tasksProgressToSave = tasks.map(t => ({
                    id: t.id,
                    status: t.status,
                    currentCount: t.isCountable ? t.currentCount : undefined
                }));
                const { error } = await supabaseClient.from('members').update({ tasks: tasksProgressToSave }).eq('id', currentMember.id);
                if (error) {
                    console.error("Failed to save progress:", error);
                    alert("進度儲存失敗，請檢查網路連線。");
                }
            }
            
            function logout() {
                currentMember = null;
                sessionStorage.removeItem('currentMemberId');
                localStorage.removeItem('graduationCelebrated');
                document.getElementById('memberName').value = '';
                document.getElementById('memberPassword').value = '';
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('adminPanelScreen').classList.add('hidden');
                document.getElementById('adminLoginScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                showLoginRanking();
                showPublicGuestList(); 
                renderCalendar();
            }
            
            async function checkSession() {
                const memberId = sessionStorage.getItem('currentMemberId');
                if (memberId) {
                    const { data, error } = await supabaseClient.from('members').select('*').eq('id', parseInt(memberId)).single();
                    if (data && !error) {
                        currentMember = data;
                        loadTasksFromMemberData(currentMember.tasks);
                        updateMemberDisplay(currentMember.name);
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('mainContent').classList.remove('hidden');
                        generateCategoryFilters();
                        renderTasks();
                        updateProgress();
                    } else {
                        sessionStorage.removeItem('currentMemberId');
                    }
                }
            }
            
            let currentFilter = 'all';

            function updateTaskStatus(taskId, newStatus) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    const oldStatus = task.status;
                    task.status = newStatus;
                    if (task.isCountable && newStatus === 'not-started') task.currentCount = 0;
                    if (oldStatus !== 'completed' && newStatus === 'completed') showCelebration(task.title);
                    renderTasks();
                    updateProgress();
                    saveTasksToDB();
                }
            }

            function incrementCount(taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task && task.isCountable && (task.currentCount || 0) < task.targetCount) {
                    task.currentCount = (task.currentCount || 0) + 1;
                    if (task.currentCount === 1 && task.status === 'not-started') task.status = 'in-progress';
                    if (task.currentCount === task.targetCount) {
                        task.status = 'completed';
                        showCelebration(task.title);
                    }
                    renderTasks();
                    updateProgress();
                    saveTasksToDB();
                }
            }

            function decrementCount(taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task && task.isCountable && (task.currentCount || 0) > 0) {
                    task.currentCount--;
                    if (task.currentCount === 0) task.status = 'not-started';
                    else if (task.currentCount < task.targetCount) task.status = 'in-progress';
                    renderTasks();
                    updateProgress();
                    saveTasksToDB();
                }
            }
            
            function updateMemberDisplay(name) {
                document.getElementById('displayMemberName').textContent = name;
                document.getElementById('memberAvatar').textContent = name.charAt(0).toUpperCase();
            }

            async function showLoginRanking() {
                const { data: members, error } = await supabaseClient.from('members').select('name, industry, created_at, tasks');
                if (error) { console.error("Error fetching members for ranking:", error); return; }
                const ranking = [];
                const graduated = [];
                members.forEach(member => {
                    const progress = calculateMemberProgress(member.tasks);
                    const memberData = { name: member.name, industry: member.industry, joinDate: member.created_at, ...progress };
                    if (progress.percentage >= 100) graduated.push(memberData);
                    else ranking.push(memberData);
                });
                ranking.sort((a, b) => b.percentage - a.percentage || b.completedCount - a.completedCount);
                graduated.sort((a, b) => new Date(a.joinDate) - new Date(b.joinDate));
                const graduatedSection = document.getElementById('graduatedMembersSection');
                const graduatedList = document.getElementById('graduatedMembersList');
                if (graduated.length > 0) {
                    graduatedList.innerHTML = graduated.map(member => `<div class="bg-gradient-to-r from-yellow-500/30 to-orange-500/30 rounded-lg p-4 border border-yellow-400/50"><div class="flex items-center space-x-3"><div class="w-12 h-12 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-full flex items-center justify-center text-white font-bold">${member.name.charAt(0).toUpperCase()}</div><div class="flex-1"><h3 class="text-yellow-100 font-semibold text-lg">${member.name}</h3><p class="text-yellow-200 text-sm">${member.industry}</p><p class="text-yellow-300 text-xs">出村日期：${new Date(member.joinDate).toLocaleDateString('zh-TW')}</p></div><div class="text-3xl">🎓</div></div></div>`).join('');
                    graduatedSection.classList.remove('hidden');
                } else {
                    graduatedSection.classList.add('hidden');
                }
                const rankingSection = document.getElementById('loginRankingSection');
                const rankingList = document.getElementById('loginRankingList');
                if (ranking.length > 0) {
                    rankingList.innerHTML = ranking.slice(0, 10).map((member, index) => `<div class="bg-white/5 rounded-lg p-4 flex items-center justify-between hover:bg-white/10 transition-all"><div class="flex items-center space-x-4"><div class="text-2xl font-bold text-white w-8 text-center">${index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}`}</div><div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">${member.name.charAt(0).toUpperCase()}</div><div><h3 class="text-white font-semibold">${member.name}</h3><p class="text-blue-200 text-sm">${member.industry}</p><p class="text-blue-300 text-xs">加入：${new Date(member.joinDate).toLocaleDateString('zh-TW')}</p></div></div><div class="text-right"><div class="text-2xl font-bold text-white">${member.percentage}%</div><div class="text-blue-200 text-sm">${member.completedCount}/${member.totalCount} 必修</div><div class="text-blue-300 text-xs">完成${member.completed} | 進行${member.inProgress}</div></div></div>`).join('');
                    if (ranking.length > 10) rankingList.innerHTML += `<div class="text-center text-blue-300 text-sm py-2">還有 ${ranking.length - 10} 位導生未顯示...</div>`;
                    rankingSection.classList.remove('hidden');
                } else if (graduated.length === 0) {
                    rankingList.innerHTML = '<div class="text-center text-blue-300 py-8">目前還沒有導生資料</div>';
                    rankingSection.classList.remove('hidden');
                } else {
                    rankingSection.classList.add('hidden');
                }
            }
            
            function calculateMemberProgress(memberTasks) {
                if (!Array.isArray(memberTasks)) return { completedCount: 0, totalCount: 0, percentage: 0, completed: 0, inProgress: 0 };
                let requiredCompletedCount = 0;
                let requiredTasks = tasksMasterList.filter(t => t.isRequired);
                let requiredTotalCount = requiredTasks.length;
                const mspTaskIds = tasksMasterList.filter(t => t.title && t.title.includes("MSP")).map(t => t.id);
                if (mspTaskIds.length > 1 && requiredTasks.some(t => mspTaskIds.includes(t.id))) {
                    requiredTotalCount -= (mspTaskIds.length - 1);
                }
                const hasCompletedMSP = mspTaskIds.length > 0 && requiredTasks.some(task => 
                    mspTaskIds.includes(task.id) && memberTasks.some(mt => mt.id === task.id && mt.status === 'completed')
                );
                let mspCounted = false;
                requiredTasks.forEach(task => {
                    const memberTask = memberTasks.find(mt => mt.id === task.id);
                    if (mspTaskIds.includes(task.id)) {
                        if (hasCompletedMSP && !mspCounted) {
                           requiredCompletedCount += 1;
                           mspCounted = true; 
                        }
                    } else if (task.isCountable) {
                         requiredCompletedCount += (memberTask?.currentCount || 0) / (task.targetCount || 1);
                    } else {
                        if (memberTask?.status === 'completed') requiredCompletedCount++;
                    }
                });
                const allMemberTasks = tasksMasterList.map(templateTask => {
                    const progress = memberTasks.find(p => p.id === templateTask.id);
                    return { ...templateTask, status: progress ? progress.status : 'not-started' };
                });
                const completed = allMemberTasks.filter(t => t.status === 'completed').length;
                const inProgress = allMemberTasks.filter(t => t.status === 'in-progress').length;
                const percentage = requiredTotalCount > 0 ? Math.round((requiredCompletedCount / requiredTotalCount) * 100) : 0;
                return { completedCount: Math.floor(requiredCompletedCount), totalCount: requiredTotalCount, percentage: Math.min(100, percentage), completed, inProgress };
            }

            function generateCategoryFilters() {
                const categories = [...new Set(tasksMasterList.map(task => task.category))];
                const container = document.getElementById('categoryFilters');
                container.innerHTML = '<button type="button" class="category-filter active bg-white/10 backdrop-blur-lg px-4 py-2 rounded-full text-white text-base font-medium border border-white/20" data-category="all">全部</button>';
                const allButton = container.querySelector('[data-category="all"]');
                const requiredCount = tasksMasterList.filter(t => t.isRequired).length;
                const optionalCount = tasksMasterList.filter(t => !t.isRequired).length;
                allButton.textContent = `全部 (${requiredCount}必修+${optionalCount}選修)`;
                allButton.addEventListener('click', () => filterTasks('all'));
                categories.forEach(category => {
                    if(!category) return;
                    const count = tasksMasterList.filter(task => task.category === category).length;
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'category-filter bg-white/10 backdrop-blur-lg px-4 py-2 rounded-full text-white text-base font-medium border border-white/20';
                    button.setAttribute('data-category', category);
                    button.textContent = `${category} (${count})`;
                    button.addEventListener('click', () => filterTasks(category));
                    container.appendChild(button);
                });
            }

            function filterTasks(category) {
                currentFilter = category;
                document.querySelectorAll('.category-filter').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-category="${category}"]`).classList.add('active');
                renderTasks();
            }

            function renderTasks() {
                const container = document.getElementById('taskContainer');
                if (!container) return;
                container.innerHTML = '';
                if (tasks.length === 0) {
                    container.innerHTML = '<p class="text-white text-center md:col-span-2 lg:col-span-3">目前沒有任何任務，請導師至後台新增。</p>';
                    return;
                }
                const filteredTasks = currentFilter === 'all' ? tasks : tasks.filter(task => task.category === currentFilter);
                filteredTasks.forEach(task => {
                    const statusClass = task.status === 'completed' ? 'completed' : task.status === 'in-progress' ? 'in-progress' : 'not-started';
                    const statusText = task.status === 'completed' ? '已完成' : task.status === 'in-progress' ? '進行中' : '未開始';
                    const statusIcon = task.status === 'completed' ? '✅' : task.status === 'in-progress' ? '⏳' : '⭕';
                    const difficultyColor = task.difficulty === '基礎' ? 'text-green-400' : task.difficulty === '進階' ? 'text-yellow-400' : task.difficulty === '考核' ? 'text-red-400' : task.difficulty === '選修' ? 'text-purple-400' : 'text-orange-400';
                    const countDisplay = task.isCountable ? `<div class="bg-blue-500/20 rounded-lg p-2 mb-3"><div class="flex items-center justify-between"><span class="text-xs text-blue-300">進度</span><span class="text-sm font-bold text-blue-200">${task.currentCount || 0}/${task.targetCount}</span></div><div class="w-full bg-white/10 rounded-full h-2 mt-1"><div class="bg-blue-400 h-2 rounded-full transition-all" style="width: ${((task.currentCount || 0) / task.targetCount) * 100}%"></div></div></div>` : '';
                    const card = document.createElement('div');
                    card.className = `task-card bg-white/10 backdrop-blur-lg rounded-2xl p-5 border border-white/20 ${statusClass}`;
                    card.innerHTML = `
                        <div class="flex items-start justify-between mb-3"><div class="text-3xl">${task.icon || '📝'}</div><div class="flex items-center space-x-2"><span class="text-sm ${statusIcon === '✅' ? 'text-green-300' : statusIcon === '⏳' ? 'text-yellow-300' : 'text-blue-300'}">${statusIcon}</span><span class="text-xs ${statusIcon === '✅' ? 'text-green-300' : statusIcon === '⏳' ? 'text-yellow-300' : 'text-blue-300'}">${statusText}</span></div></div>
                        <h3 class="text-xl font-semibold text-white mb-2 leading-tight">${task.title}</h3> <p class="text-blue-200 mb-3 text-base leading-relaxed">${task.description}</p> ${countDisplay}
                        <div class="flex items-center justify-between mb-3"><span class="text-sm ${difficultyColor} font-medium px-2 py-1 bg-white/10 rounded">${task.difficulty}</span><span class="text-sm text-purple-300">🎁 ${task.reward}</span></div>
                        <div class="text-sm text-blue-300 mb-3">${task.category}</div>
                        <div class="bg-white/5 rounded-lg p-3 mb-3">
                            <div class="text-sm text-gray-300 mb-1">完成條件：</div><div class="text-sm text-white">${task.completionCondition}</div>
                            ${task.videoUrl ? `<div class="mt-2"><button type="button" class="external-link-btn inline-flex items-center text-sm text-blue-300 hover:text-blue-200" data-url="${task.videoUrl}">📹 觀看教學影片</button></div>` : ''}
                            ${task.fbUrl ? `<div class="mt-2"><button type="button" class="external-link-btn inline-flex items-center text-sm text-blue-300 hover:text-blue-200" data-url="${task.fbUrl}">👍 前往FB粉專</button></div>` : ''}
                            ${task.courseUrl ? `<div class="mt-2"><button type="button" class="external-link-btn inline-flex items-center text-sm text-blue-300 hover:text-blue-200" data-url="${task.courseUrl}">📚 前往課程報名</button></div>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            ${task.category === '導師考核' ? `<div class="flex-1 text-center py-2 px-3 bg-orange-600/50 text-orange-200 rounded-lg text-base">⚠️ 僅導師可操作</div>` : task.isCountable ? `${(task.currentCount || 0) < task.targetCount ? `<button type="button" class="increment-btn flex-1 py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium" data-task-id="${task.id}">+1 次參與</button>` : ''}${(task.currentCount || 0) > 0 ? `<button type="button" class="decrement-btn py-2 px-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium" data-task-id="${task.id}">-1</button>` : ''}` : `${task.status !== 'completed' ? `<button type="button" class="update-status-btn flex-1 py-2 px-3 rounded-lg font-medium ${task.status === 'not-started' ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white'}" data-task-id="${task.id}" data-new-status="${task.status === 'not-started' ? 'in-progress' : 'completed'}">${task.status === 'not-started' ? '開始' : '完成'}</button>` : ''}${task.status !== 'not-started' ? `<button type="button" class="reset-status-btn py-2 px-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium" data-task-id="${task.id}">重置</button>` : ''}`}
                        </div>`;
                    container.appendChild(card);
                });
                bindTaskEvents();
            }

            function bindTaskEvents() {
                document.querySelectorAll('.external-link-btn').forEach(btn => btn.addEventListener('click', function(e) { e.stopPropagation(); openExternalLink(this.dataset.url); }));
                document.querySelectorAll('.increment-btn').forEach(btn => btn.addEventListener('click', function(e) { e.stopPropagation(); incrementCount(parseInt(this.dataset.taskId)); }));
                document.querySelectorAll('.decrement-btn').forEach(btn => btn.addEventListener('click', function(e) { e.stopPropagation(); decrementCount(parseInt(this.dataset.taskId)); }));
                document.querySelectorAll('.update-status-btn').forEach(btn => btn.addEventListener('click', function(e) { e.stopPropagation(); updateTaskStatus(parseInt(this.dataset.taskId), this.dataset.newStatus); }));
                document.querySelectorAll('.reset-status-btn').forEach(btn => btn.addEventListener('click', function(e) { e.stopPropagation(); updateTaskStatus(parseInt(this.dataset.taskId), 'not-started'); }));
            }
            
            function showCelebration(taskTitle) {
                const modal = document.getElementById('celebrationModal');
                modal.querySelector('h3').textContent = '恭喜完成任務！';
                modal.querySelector('.text-6xl').textContent = '🎉';
                modal.querySelector('#celebrationText').textContent = `你已經完成了「${taskTitle}」任務！`;
                modal.querySelector('button').textContent = '繼續加油！';
                modal.classList.add('flex');
                modal.classList.remove('hidden');
                setTimeout(() => { modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10);
            }
            
            function closeCelebration() {
                const modal = document.getElementById('celebrationModal');
                modal.querySelector('div').classList.remove('scale-100');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 200);
            }

            function showGraduationCelebration() {
                const modal = document.getElementById('celebrationModal');
                modal.querySelector('h3').textContent = '🎊 恭喜出村！🎊';
                modal.querySelector('.text-6xl').textContent = '🏆';
                modal.querySelector('#celebrationText').textContent = '恭喜你完成了BNI雲貴分會新手村的所有必修任務！';
                modal.querySelector('button').textContent = '繼續加油！';
                modal.classList.add('flex');
                modal.classList.remove('hidden');
                setTimeout(() => { modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10);
            }
            
            function updateProgress() {
                const completed = tasks.filter(t => t.status === 'completed').length;
                const inProgress = tasks.filter(t => t.status === 'in-progress').length;
                const notStarted = tasks.filter(t => t.status === 'not-started').length;
                const progress = calculateMemberProgress(currentMember?.tasks || []);
                document.getElementById('completedCount').textContent = `${progress.completedCount}/${progress.totalCount}`;
                document.getElementById('completedTasks').textContent = completed;
                document.getElementById('inProgressTasks').textContent = inProgress;
                document.getElementById('notStartedTasks').textContent = notStarted;
                document.getElementById('totalTasks').textContent = progress.totalCount;
                document.getElementById('progressPercent').textContent = progress.percentage + '%';
                const circle = document.getElementById('progressCircle');
                const circumference = 2 * Math.PI * 52;
                const offset = circumference - (progress.percentage / 100) * circumference;
                circle.style.strokeDashoffset = offset;
                if (progress.percentage === 100 && !localStorage.getItem('graduationCelebrated')) {
                    setTimeout(() => { showGraduationCelebration(); localStorage.setItem('graduationCelebrated', 'true'); }, 1000);
                }
            }
            
            function openExternalLink(url) { window.open(url, '_blank', 'noopener,noreferrer'); }
            function getAdminPassword() { return localStorage.getItem('adminPassword') || 'bni2025'; }
            function setAdminPassword(newPassword) { localStorage.setItem('adminPassword', newPassword); }
            function showAdminLogin() { document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('adminLoginScreen').classList.add('flex'); document.getElementById('adminLoginScreen').classList.remove('hidden');}
            function hideAdminLogin() { document.getElementById('adminLoginScreen').classList.add('hidden'); document.getElementById('adminLoginScreen').classList.remove('flex'); document.getElementById('loginScreen').classList.remove('hidden'); document.getElementById('adminPassword').value = ''; }
            
            function handleAdminLogin() {
                const password = document.getElementById('adminPassword').value;
                if (password === getAdminPassword()) {
                    document.getElementById('adminLoginScreen').classList.add('hidden');
                    document.getElementById('adminLoginScreen').classList.remove('flex');
                    document.getElementById('adminPassword').value = '';
                    showAdminPanel();
                } else {
                    alert('密碼錯誤');
                    document.getElementById('adminPassword').value = '';
                }
            }
            
            function showAdminPanel() { document.getElementById('adminPanelScreen').classList.remove('hidden'); hideAdminSections(); }
            function hideAdminPanel() { document.getElementById('adminPanelScreen').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); showLoginRanking(); }
            function hideAdminSections() { document.querySelectorAll('.admin-section').forEach(section => section.classList.add('hidden')); }
            function showAddMember() { hideAdminSections(); document.getElementById('addMemberSection').classList.remove('hidden'); }
            
            // ... (All other admin panel show functions like showMemberList, showMemberManagement, etc.)

            // ★★★ Calendar Functions (NEW MONTHLY VIEW) ★★★
            function getMonthName(monthIndex) {
                const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
                return monthNames[monthIndex];
            }

            async function renderCalendar() {
                const calendarBody = document.getElementById('calendarBody');
                const currentMonthYear = document.getElementById('currentMonthYear');
                if (!calendarBody || !currentMonthYear) return;
                calendarBody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-white">正在載入活動...</td></tr>';
                const year = calendarNavDate.getFullYear();
                const month = calendarNavDate.getMonth();
                currentMonthYear.textContent = `${year}年 ${getMonthName(month)}`;
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const daysInMonth = lastDayOfMonth.getDate();
                const startDayOfWeek = firstDayOfMonth.getDay();
                const firstDateStr = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                const lastDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;
                const { data: events, error } = await supabaseClient.from('calendar_events').select('*').gte('event_date', firstDateStr).lte('event_date', lastDateStr);
                if (error) {
                    calendarBody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-red-400">無法載入活動</td></tr>';
                    return;
                }
                const eventsByDate = {};
                if (events) {
                    events.forEach(event => {
                        const eventDate = new Date(event.event_date.replace(/-/g, '/'));
                        const day = eventDate.getDate();
                        if (!eventsByDate[day]) { eventsByDate[day] = []; }
                        eventsByDate[day].push(event);
                    });
                }
                calendarBody.innerHTML = '';
                let date = 1;
                for (let i = 0; i < 6; i++) {
                    const row = document.createElement('tr');
                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement('td');
                        cell.className = 'p-2 align-top border border-white/10 calendar-day';
                        if (i === 0 && j < startDayOfWeek) {
                            cell.classList.add('bg-transparent');
                        } else if (date > daysInMonth) {
                            cell.classList.add('bg-transparent');
                        } else {
                            cell.classList.add('bg-white/5');
                            const today = new Date();
                            const isToday = date === today.getDate() && year === today.getFullYear() && month === today.getMonth();
                            if (isToday) { cell.classList.add('calendar-day-today'); }
                            const dayNumber = document.createElement('div');
                            dayNumber.className = 'day-number w-6 h-6 flex items-center justify-center rounded-full text-sm font-semibold mb-1';
                            dayNumber.textContent = date;
                            cell.appendChild(dayNumber);
                            if (eventsByDate[date]) {
                                const eventsContainer = document.createElement('div');
                                eventsContainer.className = 'space-y-1';
                                eventsByDate[date].forEach(event => {
                                    const eventDiv = document.createElement('div');
                                    eventDiv.className = 'event-item text-xs p-1 rounded truncate hover:whitespace-normal hover:bg-white/20 cursor-pointer';
                                    eventDiv.textContent = event.title;
                                    eventDiv.title = `${event.title}\n${event.description || ''}`;
                                    eventsContainer.appendChild(eventDiv);
                                });
                                cell.appendChild(eventsContainer);
                            }
                            date++;
                        }
                        row.appendChild(cell);
                    }
                    calendarBody.appendChild(row);
                    if (date > daysInMonth) break;
                }
            }
            
            async function initializeApp() {
                tasksMasterList = await fetchTasksMaster();
                
                // Attach all event listeners
                document.getElementById('loginButton')?.addEventListener('click', handleLogin);
                document.getElementById('showAdminBtn')?.addEventListener('click', showAdminLogin);
                document.getElementById('logoutBtn')?.addEventListener('click', logout);
                document.getElementById('prevMonthBtn')?.addEventListener('click', () => {
                    calendarNavDate.setMonth(calendarNavDate.getMonth() - 1);
                    renderCalendar();
                });
                document.getElementById('nextMonthBtn')?.addEventListener('click', () => {
                    calendarNavDate.setMonth(calendarNavDate.getMonth() + 1);
                    renderCalendar();
                });
                document.getElementById('togglePublicGuestList').addEventListener('click', () => {
                    document.getElementById('publicGuestListContainer').classList.toggle('hidden');
                    document.getElementById('guestListChevron').classList.toggle('rotate-180');
                });
                // ... (All other event listeners)
                
                // Initial data load for login page
                await checkSession();
                await showLoginRanking();
                await showPublicGuestList(); 
                renderCalendar(); 
            }

            document.addEventListener('DOMContentLoaded', initializeApp);

        })();
    </script>
</body>
</html>

by 投嘉雲彰區域 雲貴分會 高屏區水電工程 吳志璘     V161.2行事曆版本

